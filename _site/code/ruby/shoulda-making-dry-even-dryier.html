<?xml version='1.0' encoding='utf-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <head>
    <meta content='GROW UP' http-equiv='X-UA-Compatible' />
    <meta content='width=960' name='viewport' />
    <title>The Knowldenist - Drink Up! - Shoulda: Making DRY even DRY-ier</title>
    <link href='/images/gusgus_icon.gif' rel='icon' />
    <link href="http://feeds.feedburner.com/gusgus" rel="alternate" title="The Knowldenist" type="application/atom+xml" />
    <link href='http://gusg.us/feed.xml' rel='alternate' title='The Knowldenist' type='application/atom+xml' />
    <link href="/stylesheets/reset.css" type="text/css" media="screen" rel="stylesheet"/>
    <link href="/stylesheets/960.css" type="text/css" media="screen" rel="stylesheet"/>
    <link href="/stylesheets/text.css" type="text/css" media="screen" rel="stylesheet"/>
    <link href="/stylesheets/application.css" type="text/css" media="screen" rel="stylesheet"/>
    <link href="/stylesheets/pygment-native.css" type="text/css" media="screen" rel="stylesheet"/>
  </head>

  <body>
    <div class='container_12'>
      <div id='header'>
        <div id="title" class="grid_4 alpha">
          <span class="article">The</span><span class="noun"><a href="/">Knowldenist</a></span>
        </div>
        <div id="nav" class="grid_8 omega">
          <ul>
            <li>
              Read
              <ul><li><a href="/">Home</a></li></ul>
            </li>
            <li>
              Blurp!
              <ul><li><a href="/blurp/">Excuse me</a></li></ul>
            </li>
            <li>
              Code
              <ul>
                <li><a href="http://github.com/jaknowlden">jaknowlden</a></li>
                <li><a href="http://github.com/thumblemonks">thumblemonks</a></li>
              </ul>
            </li>
            <li>
              Links
              <ul>
                <li><a href="http://tumblr.gusg.us/">Tumblr</a></li>
                <li><a href="http://twitter.com/jaknowlden">Twittr</a></li>
                <li><a href="http://flickr.com/jaknowlden">Flickr</a></li>
              </ul>
            </li>
          </ul>
        </div>
      </div>

      <div id="main" class='grid_12 alpha omega'>
        <div id="page_title">
  <h1>Shoulda: Making DRY even DRY-ier</h1>
  <div class="summary"><em>A look at how I build shoulda macros</em></div>
</div>

<div class="grid_9 alpha">
  <div id="left" class="grid_3 alpha column">
    <ul>
      <h3>Into the Future</h3>
      <li>
        <a href="/code/history-blog-meme.html">History Blog Meme</a>
        <p><em>Just like it says; a meme focused on your most typed commands</em></p>
      </li>

      <li>
        <a href="/code/erlang/erlang-diaries-vol1.html">Erlang Diaries - Vol 1</a>
        <p><em>Brought to you by the lower-case letter 'c'</em></p>
      </li>

    <h3>Check me out!</h3>
      <p><em>
        <a href="http://github.com/thumblemonks/riot">Riot</a> for fast ruby testing,
        <a href="http://jubilator.thumblemonks.com/" title="Browse GitHub in style">Jubilator</a> for GitHub browsing,
        <a href="http://seota.thumblemonks.com/" title="Semi-automatic SEO assistance">Seota</a> for semi-automatic SEO help,
        <a href="http://github.com/thumblemonks/animalcracker">Animal Cracker</a> for Rack asset hosting assistance,
        <a href="http://github.com/thumblemonks/riot">Chicago</a> for Sinatra helpers
      </em></p>
    </ul>
  </div>

  <div id="article" class="grid_6 omega">
    <div id="info">
      <div class="date"><cite>Nov 09, 2008</cite></div>
    </div>

    <div class="content"><p>I&#8217;m in love with <a href='http://thoughtbot.com/projects/shoulda'>Shoulda</a>. Not like that! Come on! I love Shoulda like a pedicurist loves sandpaper. My job would be do-able, but it would suck without it. My hands would be all crackly and stink a lot more. Not to mention I&#8217;d probably end up gouging the client and then hemorrhaging &#8230; oh god!</p>

<p>Anyways, Shoulda takes some of the pain of writing tests away by actually making the tests readable. Contexts let me scope setup and teardown the way I&#8217;ve always wanted to. It&#8217;s also very easy to generate <code>contexts</code> and <code>should</code> statements dynamically without all that <code>define_method</code> cruft.</p>

<p>Now, If I&#8217;m writing some sort of web-app - like with Rails or Sinatra - a lot of my model and controller tests tend to look the same. By the same, I mean there is an obvious pattern. Our refactoring brainwashing tells us we need to DRY this up. One obvious way of doing this is to write our own Shoulda macros by extending <code>Test::Unit::TestCase</code>, <code>ActionController::TestCase</code>, etc.</p>

<p>I prefer to extend/mix-into things by writing my own module with the methods I want and extending or including that module into the class/module the methods are intended for. Like so:</p>
<div class='highlight'><pre><code class='ruby'><span class='k'>module</span> <span class='nn'>Thumblemonks</span>
  <span class='k'>module</span> <span class='nn'>User</span>
    <span class='k'>module</span> <span class='nn'>Shoulda</span>

      <span class='k'>def</span> <span class='nf'>should_ask_for_milk_and_cookies</span>
        <span class='c1'># do someting</span>
      <span class='k'>end</span>

    <span class='k'>end</span> <span class='c1'># Shoulda</span>
  <span class='k'>end</span> <span class='c1'># User</span>
<span class='k'>end</span> <span class='c1'># Thumblemonks</span>
<span class='no'>Test</span><span class='o'>::</span><span class='no'>Unit</span><span class='o'>::</span><span class='no'>TestCase</span><span class='o'>.</span><span class='n'>extend</span><span class='p'>(</span><span class='no'>Thumblemonks</span><span class='o'>::</span><span class='no'>User</span><span class='o'>::</span><span class='no'>Shoulda</span><span class='p'>)</span>
</code></pre>
</div>
<p>I like this approach because it&#8217;s easy to find out - in like a debugger session - all of the modules that are mixed-in into a specific class/module that give said class/module it&#8217;s methods. I like this approach every time, not just for extending things for Shoulda. <em>Props to <a href='http://github.com/danhodos'>Dan Hodos</a></em></p>

<p>Now, that being said, if I am going to add my own macros for a model test case (for instance), I do not like putting all of that code into the actual file containing the test case for the model. The standard approach I&#8217;ve seen is to then put it in the <code>test_helper.rb</code> file. I dislike this for two reasons:</p>

<ol>
<li>It mentally restricts me from writing a lot of macros because it mucks up <code>test_helper</code></li>

<li><code>test_helper</code> should really just contain bootstrap code for all tests</li>
</ol>

<p>Today, however I hit upon something I liked. I created a folder under <code>test</code> in my Rails app which I called &#8230; wait for it &#8230; <code>shoulda</code>. That&#8217;s right, <code>$RAILS_HOME/test/shoulda</code>. Then, I did the following in my <code>test_helper.rb</code>:</p>
<div class='highlight'><pre><code class='ruby'><span class='c1'># including require_local_lib just because I use it everywhere</span>
<span class='k'>def</span> <span class='nf'>require_local_lib</span><span class='p'>(</span><span class='n'>pattern</span><span class='p'>)</span>
  <span class='no'>Dir</span><span class='o'>.</span><span class='n'>glob</span><span class='p'>(</span><span class='no'>File</span><span class='o'>.</span><span class='n'>join</span><span class='p'>(</span><span class='no'>File</span><span class='o'>.</span><span class='n'>dirname</span><span class='p'>(</span><span class='bp'>__FILE__</span><span class='p'>),</span> <span class='n'>pattern</span><span class='p'>))</span><span class='o'>.</span><span class='n'>each</span> <span class='p'>{</span><span class='o'>|</span><span class='n'>f</span><span class='o'>|</span> <span class='nb'>require</span> <span class='n'>f</span> <span class='p'>}</span>
<span class='k'>end</span>
<span class='n'>require_local_lib</span><span class='p'>(</span><span class='s1'>&#39;shoulda/*.rb&#39;</span><span class='p'>)</span>
</code></pre>
</div>
<p>Then, I started creating a new file in shoulda - as I needed it - for each model I was testing. For instance, I was testing a <code>Membership</code> model and ended up creating <code>test/shoulda/membership.rb</code>. Seems simple, but I did sooooo much test refactoring in the process and my test cases ended up looking insanely clean and readable.</p>

<p>So, morals of the story are:</p>

<ol>
<li>Use Shoulda, though you shoulda been doing it already &#8230; <a href='http://www.sadtrombone.com/'>sad trombone</a></li>

<li>Do break your shoulda macros into their own files</li>

<li>Keep shtuff out of <code>test_helper</code> that isn&#8217;t helping bootstrap test cases</li>

<li>Refactor your tests mercilessly &#8230; but, you already knew that</li>
</ol>

<h2 id='update'>Update</h2>

<ol>
<li>I wrote this before shoulda included a mechanism for loading macros from a pre-defined directory (I think)</li>
</ol></div>
  </div>

  
  <div id="grumble">
    <h4 class="count"></h4>
    <ul></ul>

    <div id="disqus_thread"></div>
    <script type="text/javascript" src="http://disqus.com/forums/gusgus/embed.js"></script>
    <noscript><a href="http://disqus.com/forums/gusgus/?url=ref">View the discussion thread.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">powered by <span class="logo-disqus">Disqus</span></a>
  </div>
  
</div>

<div id="right" class="grid_3 omega column">
  <ul>
    <h3>Into the Past</h3>
    <li>
      <a href="/code/ruby/smurf-rails-autominifying-js-css-plugin.html">Smurf</a>
      <p><em>Rails Javascript & CSS Auto-minifying plugin</em></p>
    </li>

    <li>
      <a href="/life/me-me-meme.html">The Me Me Meme</a>
      <p><em>Me me meme memememe me mme meme</em></p>
    </li>

    <p><em>
      Check out these fine products:
      <a href="http://ackandnak.com/">Ack &amp; Nak</a> many-days-a-week web comic,
      <a href="http://dailyjs.com/">DailyJS</a>,
      <a href="http://helicoid.net/">Helicoid</a>,
      <a href="http://swirrl.com/">Swirrl</a>,
      <a href="http://javagems.org/">Java Gems</a>, et al
    </em></p>
  </ul>
</div>

      </div>

      <div class='grid_12 alpha omega' id='footer'>
        <a href="http://feeds2.feedburner.com/gusgus" rel="alternate" type="application/rss+xml">
          <img src="http://www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt="" style="vertical-align:middle;border:0"/></a>
        &copy; 2007 - right now, Justin Knowlden /
        <span id="other_thumble_monks">
          Other Thumble Monks:
          <a href="http://annealer.org/">Annealer</a>,
          <a href="http://github.com/danhodos">Sandman</a>,
          <a href="http://toothrot.net/">Toothrot</a>,
          <a href="http://hjstudios.com/">JankStar</a>,
          <a href="http://andrijevik.net/">Vladka</a>
        </span>
      </div>
    </div>

    <script src="/javascripts/disqus.js"></script>
    <script src="/javascripts/ga.js"></script>
  </body>
</html>
