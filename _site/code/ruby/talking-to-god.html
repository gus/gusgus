<?xml version='1.0' encoding='utf-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <head>
    <meta content='GROW UP' http-equiv='X-UA-Compatible' />
    <meta content='width=850' name='viewport' />
    <title>GusG.us - Ruby - Talking to God should be easier</title>
    <link href='/images/gusgus_icon.gif' rel='icon' />
    <link href='http://gusg.us/feed.xml' rel='alternate' title='GusG.us' type='application/rss+xml' />
    <link href="/stylesheets/reset-min.css" type="text/css" media="screen" rel="stylesheet"/>
    <link href="/stylesheets/application.css" type="text/css" media="screen" rel="stylesheet"/>
    <link href="/stylesheets/pygment-native.css" type="text/css" media="screen" rel="stylesheet"/>
  </head>

  <body>
    <div class='container'>
      <div id='header'>
        <a href='http://gusg.us'>
          <img src='/images/gus-logo.png' />
        </a>
        <span class='nav'>
          <a href='/'>Home</a>
          <a href='/life'>Life</a>
          <a href='/work'>Work</a>
          <a href='/code'>Code</a>
          <a href='/code/ruby'>Ruby</a>
          <a href='/code/erlang'>Erlang</a>
        </span>
        <a href='http://feeds.feedburner.com/gusgus' rel='alternate' type='application/rss+xml'>
          <img src='http://www.feedburner.com/fb/images/pub/feed-icon16x16.png' />
        </a>
      </div>

      <div id="article">
  <h1>Ruby - Talking to God should be easier</h1>
  <em>A look into one way to talk to God</em>
  <cite>Sat Dec 20 00:00:00 -0600 2008</cite>
  <p>I recently started writing my <a href='http://github.com/thumblemonks/evoke'>Evoke</a> service (a nice, little <a href='http://sinatra.rubyforge.org/'>Sinatra</a> app). Part of the Evoke service is actually delivering on the promise of calling a stored URL back, which I achieved by storing a runner as a <a href='http://github.com/tobi/delayed_job'>delayed job</a>. Only half the battle is writing the consumer, though. The other half is ensuring that the runner is daemonized and that the daemon is restarted if ever it were to die. This is where <a href='http://god.rubyforge.org/'>god</a> enters the picture.</p>

<p>For the Evoke consumer, I wrote a little god script that I package with the Evoke bundle. This script is easily configured to run from the command like so (relative to the evoke source code):</p>
<div class='highlight'><pre>god -c config/evoke.god
</pre>
</div>
<p>With that, the consumer is running and will be restarted if ever it dies. With Evoke, I added a status page which can be accessed via the world-wide-web. Status just shows me a few things about the particular Evoke instance, like: a view of the last 10 callbacks, how many callbacks in total, how many coming up, are any callbacks still pending that should not be, etc.</p>

<p>To this status page I also added a little checker to make sure the Evoke consumer was running. If running, I get a nice green &#8220;running&#8221;; else, I get a nasty red &#8220;not running&#8221;. Naturally - god being a ruby app and all - I wanted to ask god if it was running. As it turns out, this is not as straightforward as it would seem.</p>

<p><em>I see now that this article is going to be hard to get through without a lot of giggling on my part</em></p>

<h3 id='one_would_think'>One would think</h3>

<p>One would think that they could just require in the <code>god</code> library and use the API to ask for the state of a particular job. In my head, I would do this from IRB:</p>
<div class='highlight'><pre><span class='nb'>require</span> <span class='s1'>&#39;god&#39;</span>
<span class='no'>God</span><span class='o'>.</span><span class='n'>status</span><span class='p'>(</span><span class='s1'>&#39;evoke_consumer&#39;</span><span class='p'>)</span>
<span class='o'>=&gt;</span> <span class='p'>{</span><span class='ss'>:state</span> <span class='o'>=&gt;</span> <span class='ss'>:up</span><span class='p'>}</span>
</pre>
</div>
<p>But &#8230; nope. No way that I could see that is. So I went digging through the source and eventually had to find my way to the god shell script that gets executed from the command line. Which then led me to <code>God::CLI::CommandLine</code>. This is the only place where we can see the mysteries of god. <code>DRb</code> droppings. The info I need being printed to standard out. Everything I need to make one call, but all wrapped into a command line interface. I clearly cannot call any methods here.</p>

<p>It&#8217;s also clear that god was not intended to be accessed through more than one interface, without a lot of redundant code. Basically, I am forced into command line mode or parsing the results of an execution, unless I want some hackery. Hackery it is. After a little playing around and dealing with permissions and such (which is very cool of DRb and god to take care of for me), I wrote this little method into my <code>Status</code> class:</p>
<div class='highlight'><pre><span class='k'>def</span> <span class='nf'>consumer_running?</span>
  <span class='no'>DRb</span><span class='o'>.</span><span class='n'>start_service</span><span class='p'>(</span><span class='s2'>&quot;druby://127.0.0.1:0&quot;</span><span class='p'>)</span>
  <span class='n'>server</span> <span class='o'>=</span> <span class='no'>DRbObject</span><span class='o'>.</span><span class='n'>new</span><span class='p'>(</span><span class='kp'>nil</span><span class='p'>,</span> <span class='no'>God</span><span class='o'>::</span><span class='no'>Socket</span><span class='o'>.</span><span class='n'>socket</span><span class='p'>(</span><span class='mi'>17165</span><span class='p'>))</span>

  <span class='n'>server</span><span class='o'>.</span><span class='n'>status</span><span class='o'>[</span><span class='s2'>&quot;evoke_consumer&quot;</span><span class='o'>][</span><span class='ss'>:state</span><span class='o'>]</span> <span class='o'>==</span> <span class='ss'>:up</span>
<span class='k'>rescue</span> <span class='no'>DRb</span><span class='o'>::</span><span class='no'>DRbConnError</span>
  <span class='kp'>false</span>
<span class='k'>ensure</span>
  <span class='no'>DRb</span><span class='o'>.</span><span class='n'>stop_service</span>
<span class='k'>end</span>
</pre>
</div>
<p>Most of that is straight up jacked from god (except for the <code>DRb.stop_service</code> :o ). I don&#8217;t see why that would be so hard for god to let me do with what I intended earlier:</p>
<div class='highlight'><pre><span class='no'>God</span><span class='o'>.</span><span class='n'>status</span><span class='p'>(</span><span class='s1'>&#39;evoke_consumer&#39;</span><span class='p'>)</span>
</pre>
</div>
<p>Come on god! Get with the program!</p>

<p>Anyways, I intend to fix god so that I can do that. Hopefully, the master of god will accept?!?! I may be way out of my mind here and there may be a much easier way to do this. If so, shoot me an email (see address in the footer) with the solution.</p>
</div>
 
<div id="related">
  <h3>Related Posts</h3>
  <ul class="posts">
    
      <li><span>05 Jan 2009</span> &raquo; <a href="/life/thumbly-going-on.html">Thumbly Going On</a></li>
    
      <li><span>03 Jan 2009</span> &raquo; <a href="/code/ruby/load-model.html">Load Model</a></li>
    
      <li><span>20 Dec 2008</span> &raquo; <a href="/life/boring-bed-poem.html">Poem - Boring Bed</a></li>
    
  </ul>
</div>


    </div>
    <div class='container'>
      <div class='clear' id='footer'>
        &copy; 2007 - 2009 Justin Knowlden,
        <span class='email'>gus at gusg dot us</span>
        <span class='powered'>
          - Powered by <a href=''>Jekyll</a>,
          <a href=''>Markdown</a>,
          <a href='http://rubyforge.org/projects/syntaxi/'>Syntaxi</a>, and me
        </span>
      </div>
    </div>
    <a href='http://github.com/jaknowlden'>
      <img alt='Fork me on GitHub' id='ribbon' src='http://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png' />
    </a>
    <script src="http://ajax.googleapis.com/ajax/libs/prototype/1.6.0.3/prototype.js" type="text/javascript"></script>
    <script src="/javascripts/jquery-1.2.6.min.js" type="text/javascript"></script>
    <script src="http://grumble.annealer.org/javascripts/grumbler/api.js" type="text/javascript"></script>
    <script src="/javascripts/grumble_support.js" type="text/javascript"></script>
  </body>
</html>