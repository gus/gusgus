<?xml version='1.0' encoding='utf-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <head>
    <meta content='GROW UP' http-equiv='X-UA-Compatible' />
    <meta content='width=850' name='viewport' />
    <title>GusG.us - JSON in Rails Just Annoyed Me</title>
    <link href='/images/gusgus_icon.gif' rel='icon' />
    <link href="http://feeds.feedburner.com/gusgus" rel="alternate" title="GusG.us" type="application/atom+xml" />
    <link href='http://gusg.us/feed.xml' rel='alternate' title='GusG.us' type='application/atom+xml' />
    <link href="/stylesheets/reset.css" type="text/css" media="screen" rel="stylesheet"/>
    <link href="/stylesheets/960.css" type="text/css" media="screen" rel="stylesheet"/>
    <link href="/stylesheets/text.css" type="text/css" media="screen" rel="stylesheet"/>
    <link href="/stylesheets/application.css" type="text/css" media="screen" rel="stylesheet"/>
    <link href="/stylesheets/pygment-native.css" type="text/css" media="screen" rel="stylesheet"/>
  </head>

  <body>

    <div class='container_12'>
      <div id='header' class='grid_12 alpha omega'>
        <div id='logo'>
          <img src="/images/gus-logo.png" alt="gusg.us">
        </div>
        <div id='nav' class="prefix_5 alpha grid_7 omega">
          <ul>
            <li><a href='/work'>Work</a></li>
            <li><a href='/code'>Code</a></li>
            <li><a href='/life'>Life</a></li>
            <li><a href='/'>Home</a></li>
          </ul>
        </div>
      </div>

      <div class='grid_12 alpha omega'>
        <div id="article">
  <div class="header clearfix">
    <h1>JSON in Rails Just Annoyed Me</h1>
    <div id="info">
      <span class="date"><cite>May 25, 2008</cite></span>
      <span class="summary"><em>Seriously, things just shouldn't be as hard as they are</em></span>
    </div>
  </div>
  <p>Man. I was really having fun coding up JSON responses in one of my Rails apps. Until, that is, I wanted to do something custom.</p>

<p>Now, you might ask, <em>&#8220;Why would you want to do something custom?&#8221;</em></p>

<p>To which I would reply, <em>&#8220;Sigh. Because I&#8217;m just that way.&#8221;</em></p>

<h2 id='get_on_with_it'>Get on with it</h2>

<p>Ok, I&#8217;ve got this <code>ActiveRecord</code> model called <code>Fact</code>. <code>Fact</code> has attributes <code>:key</code> and <code>:value</code> along with the other normal columns (i.e. <code>:id</code>, <code>:created_at</code>, etc.).</p>

<p>I want to use <code>Fact</code> in one of my views and I export it to JSON. I only care about the <code>:key</code> and <code>:value</code> and the obvious solution is to:</p>
<div class='highlight'><pre><span class='n'>fact</span> <span class='o'>=</span> <span class='no'>Fact</span><span class='o'>.</span><span class='n'>create</span><span class='p'>(</span><span class='ss'>:key</span> <span class='o'>=&gt;</span> <span class='s1'>&#39;foo&#39;</span><span class='p'>,</span> <span class='ss'>:value</span> <span class='o'>=&gt;</span> <span class='s1'>&#39;bar&#39;</span><span class='p'>)</span>
<span class='n'>fact</span><span class='o'>.</span><span class='n'>to_json</span><span class='p'>(</span><span class='ss'>:only</span> <span class='o'>=&gt;</span> <span class='o'>[</span><span class='ss'>:key</span><span class='p'>,</span> <span class='ss'>:value</span><span class='o'>]</span><span class='p'>)</span>
</pre>
</div>
<p>Which returns something like:</p>
<div class='highlight'><pre><span class='p'>{</span><span class='s2'>&quot;key&quot;</span><span class='o'>:</span> <span class='s2'>&quot;foo&quot;</span><span class='o'>,</span> <span class='s2'>&quot;value&quot;</span><span class='o'>:</span> <span class='s2'>&quot;bar&quot;</span><span class='p'>}</span>
</pre>
</div>
<p>Ok &#8230; fine. I can do something with that, but <code>Fact</code> is really an extension of some other model, which can have many <code>Facts</code>. And I want to reference these facts by their name in a JavaScript object. I don&#8217;t want to search through the objects looking for a matching key. I want a JavaScript Object that looks something like:</p>
<div class='highlight'><pre><span class='p'>{</span><span class='s2'>&quot;foo&quot;</span><span class='o'>:</span> <span class='s2'>&quot;bar&quot;</span><span class='p'>}</span>
</pre>
</div>
<p>You might say, <em>&#8220;Get over it!&#8221;</em></p>

<p>I would say, <em>&#8220;No. This is what I want.&#8221;</em></p>

<p>I also figured it would be easy to modify <code>Fact</code> to return what I want. What I figured was that since I could call <code>to_json</code> on an <code>ActiveRecord</code>, the implementation of <code>to_json</code> would actually recursively work its way through the hierarchy of attributes and associations and call <code>to_json</code> on each of them. Thinking this was the case, I went and wrote my own <code>to_json</code> on <code>Fact</code>.</p>

<p><em>&#8220;What happened?&#8221;</em>, you ask.</p>

<p><em>&#8220;Bupkiss&#8221;</em>, I say.</p>

<p><em>&#8220;What do you mean?&#8221;</em>, you persistently ask.</p>

<p><em>&#8220;What&#8217;s with all the questions!&#8221;</em></p>

<p>The reason why nothing happens is because <code>to_json</code> hands responsibility over to the <code>ActiveRecord::Serialization::Serializer</code> class (ASS). <code>ASS</code> in turn builds up its own Hash of keys and values that it grabs from the <code>ActiveRecord</code> in question.</p>

<p>This is <strong>NOT</strong> what I would expect. Hence, my annoyance. In fact, I find it a little silly and a little broken. If this is what I expected, I would instead pass an instance of <code>Fact</code> to a JSON encoder and <code>Fact</code> would in fact know nothing of JSON. As it stands, <code>Fact</code> knows about JSON and JSON knows about <code>Fact</code> (by knowing about <code>ActiveRecord</code>).</p>

<h2 id='whatchu_goan_do'>Whatchu goan do?</h2>

<p>I don&#8217;t know yet. I&#8217;ll repost when I figure it out. I just wanted to post my annoyance. I am very, very annoyed.</p>
</div>

<div id="grumble">
  <h4 class="count"></h4>
  <ul></ul>

  <div id="disqus_thread"></div>
  <script type="text/javascript" src="http://disqus.com/forums/gusgus/embed.js"></script>
  <noscript><a href="http://disqus.com/forums/gusgus/?url=ref">View the discussion thread.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">powered by <span class="logo-disqus">Disqus</span></a>
</div>

      </div>

      <div class='grid_12 alpha omega' id='footer'>
        &copy; 2007 - 2009 Justin Knowlden,
        <span class='email'>gus at gusg dot us</span>
        <span class='powered'>
          - Powered by <a href=''>Jekyll</a>,
          <a href='http://daringfireball.net/projects/markdown/'>Markdown</a>,
          <a href='http://pygments.org/'>Pygments</a>, and me
        </span>
        <a href="http://feeds2.feedburner.com/gusgus" rel="alternate" type="application/rss+xml">
          <img src="http://www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt="" style="vertical-align:middle;border:0"/></a>
      </div>
    </div>
    <script src="/javascripts/jquery-1.2.6.min.js" type="text/javascript"></script>
    <script type="text/javascript">
    //<![CDATA[
      (function() {
        var links = document.getElementsByTagName('a');
        var query = '?';
        for(var i = 0; i < links.length; i++) {
        if(links[i].href.indexOf('#disqus_thread') >= 0) {
          query += 'url' + i + '=' + encodeURIComponent(links[i].href) + '&';
        }
        }
        document.write('<script charset="utf-8" type="text/javascript" src="http://disqus.com/forums/gusgus/get_num_replies.js' + query + '"></' + 'script>');
      })();
    //]]>
    </script>
    <script src="/javascripts/application.js" type="text/javascript"></script>
    <script type="text/javascript">
      var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
      document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
      try {
        var pageTracker = _gat._getTracker("UA-10626188-1");
        pageTracker._trackPageview();
      } catch(err) {}
    </script>
  </body>
</html>