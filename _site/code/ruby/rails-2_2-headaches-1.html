<?xml version='1.0' encoding='utf-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <head>
    <meta content='GROW UP' http-equiv='X-UA-Compatible' />
    <meta content='width=850' name='viewport' />
    <title>GusG.us - Moving to Rails 2.2 Headaches - Vol 1</title>
    <link href='/images/gusgus_icon.gif' rel='icon' />
    <link href="http://feeds.feedburner.com/gusgus" rel="alternate" title="GusG.us" type="application/atom+xml" />
    <link href='http://gusg.us/feed.xml' rel='alternate' title='GusG.us' type='application/atom+xml' />
    <link href="/stylesheets/reset-min.css" type="text/css" media="screen" rel="stylesheet"/>
    <link href="/stylesheets/application.css" type="text/css" media="screen" rel="stylesheet"/>
    <link href="/stylesheets/pygment-native.css" type="text/css" media="screen" rel="stylesheet"/>
  </head>

  <body>
    <div class='container'>
      <div id='header'>
        <div id='nav'>
          <ul>
            <li><a href='/'>Home</a></li>
            <li class=""><a href='/life'>Life</a></li>
            <li><a href='/work'>Work</a></li>
            <li><a href='/code'>Code</a></li>
            <li><a href='/code/ruby'>Ruby</a></li>
          </ul>
        </div>
        <div id="slogan" class="clear"><img src="/images/gus-slogan.png" align="center"></div>
      </div>

      <div id="article">
  <div class="header">
    <h1>Moving to Rails 2.2 Headaches - Vol 1</h1>
    <div class="date"><cite>Nov 23, 2008</cite></div>
    <div class="summary">Problems I ran into while upgrading to Rails 2.2.2</div>
    <div class="clear"></div>
  </div>
  <p>I had an itch in my butt to move our little app to the latest and greatest version of Rails - <code>2.2.2</code>. It was really itching and against my better judgements, I dug right in there and went to picking at that itch.</p>

<p>I went about my normal business of doing a <code>sudo gem install rails</code> and then a <code>rake rails:freeze:gems</code>. Simple enough. Started my tests and holy crap &#8230; tests were failing left and right! I mean, come on now. This is silly. We are basically cutting edge without being on the Edge. We use all the latest and greatest plugins and stuff. What the hell&#8217;s going on here?</p>

<p>Being that I hate farting with functional tests, or really anything in Action Pack, I started with the unit tests. They&#8217;re generally the easiest to resolve.</p>

<h3 id='shoulda'>Shoulda</h3>

<p>Shoulda was failing thanks the internationalization efforts. Our <code>should_ensure_length_in_range</code> assertions were failing because the messages were expecting the old format. A look at <a href='http://thoughtbot.lighthouseapp.com'>Shoulda&#8217;s tickets</a> yielded a <a href='http://thoughtbot.lighthouseapp.com/projects/5807/tickets/87-should_ensure_length_in_range-cant-work-with-rails22'>promising fix</a>. Thank goodness, too.</p>

<p>From that fix, I pulled the attachment and just added it to our loaded libraries; as a temporary stop-gap until the Thoughbotters get around to a new release.</p>

<p>Hey Thoughbotters, if you happen to read this, could you also patch in <a href='http://thoughtbot.lighthouseapp.com/projects/8794-paperclip/tickets/49'>Paperclip #49</a>, <a href='http://thoughtbot.lighthouseapp.com/projects/5807-shoulda/tickets/112'>Shoulda #112</a>, and <a href='http://thoughtbot.lighthouseapp.com/projects/5807-shoulda/tickets/97'>Shoulda #97</a>? Mmmmmkay, thanks.</p>

<h3 id='haml'>HAML</h3>

<p>Out of the unit tests already and into the functionals. Fudge!</p>

<p>My beloved HAML. How do I love thee. Already fixed up to support Rails <code>2.2.2</code> in <code>2.0.4</code>, but you never told me! Would have been helpful so I wasn&#8217;t looking like an ass for 30 minutes.</p>

<p>Anyways, HAML was broken because of a cool, new accessor added to ActionView called &#8230; <code>output_buffer</code>. And possibly from some other cool methods like <code>block_called_from_erb?</code>.</p>

<p>I fiddled around for another 15 minutes until I remembered that I had to <code>rake gem:unpack</code> it. We had frozen ourselves to <code>2.0.3</code>. Doh!</p>

<p>I am getting a bunch of these warnings from Rails now:</p>

<pre><code>DEPRECATION WARNING: @person will no longer be implicitly assigned to person. (called from tag at .../vendor/rails/actionpack/lib/action_view/helpers/active_record_helper.rb:249)</code></pre>

<p>Thanks to this call:</p>

<pre><code>- render({:layout =&gt; &#39;person&#39;}, :object =&gt; @person) do
  = invite_key_tag</code></pre>

<p>Why I&#8217;m getting the warnings is beyond me. I can only imagine that it has something do with line 258 of <code>action_view/base.rb</code> which does not pass the <code>local_assigns</code> around if also rendering with a layout.</p>

<pre><code>elsif options[:partial]
  render_partial(options) # 258</code></pre>

<p>Dear Rails, please stop this.</p>

<h3 id='smurf'>Smurf</h3>

<p><a href='http://github.com/thumblemonks/smurf'>I wrote it. I fixed it.</a> Took 20 minutes. The Rails team got a little more clever and a little more OO about this one. <a href='/code/ruby/smurf-rails-autominifying-js-css-plugin'>Previously</a>, asset inclusion went through a single <code>AssetTagHelper</code> method. Now, we have full blown <code>ActionView::Helpers::AssetTagHelper::JavaScriptSources</code> and <code>ActionView::Helpers::AssetTagHelper::StylesheetSources</code> classes which each encapsulate some nice behavior. The <a href='http://github.com/thumblemonks/smurf/commit/a45de3b84598ee61e274f1ae87a11850a09628ba#comments'>code change</a> for this fix is also less hacky, in my opinion.</p>

<p>One other thing I discovered while running tests, <code>sqlite3</code> doesn&#8217;t just get added anymore. I had to add the following to my test helper setup:</p>

<pre><code>config.gem &#39;sqlite3-ruby&#39;, :lib =&gt; &#39;sqlite3&#39;</code></pre>

<p>Thanks to Sam Schenkman-Moore&#8217;s <a href='http://weblog.rubyonrails.org/2008/11/21/rails-2-2-i18n-http-validators-thread-safety-jruby-1-9-compatibility-docs'>comment #56</a>.</p>

<h3 id='calendar_date_select'>Calendar Date Select</h3>

<p>Tim Charper was all over his <a href='http://github.com/timcharper/calendar_date_select/commit/68bdbf598b2f0271df1301869fc6940333802d66'>fix</a> to <a href='http://github.com/timcharper/calendar_date_select'>calendar_date_select</a>. Seems that <code>ActionView::Helpers::InstanceTag.new</code> takes one less parameter now. The one where everyone was passing in <code>nil</code> ;)</p>

<h3 id='calendar_builder'>Calendar Builder</h3>

<p>Tests were failing for the <a href='http://github.com/collectiveidea/calendar_builder'>calendar_builder</a> plugin. I don&#8217;t want to blame the <a href='http://collectiveidea.com/'>Collective Idea guys</a> for this problem, though. They were using <code>CaptureHelper#capture</code> in a class where they had included <code>CaptureHelper</code>, obviously. And it worked fine prior to Rails <code>2.2</code>. Post <code>2.1</code>, however, this class suffered the same fate as pre-2.0.4 HAML, which is the curse of the dreaded <code>nil output_buffer</code>.</p>

<p>The problem was simply that their class - named <code>Week</code> - was using <code>capture</code>, but not rendering it in any context that had access to the actual <code>output_buffer</code> instance variable. However, the calling method in <code>CalendarBuilder#calendar</code> did. So, a few <a href='http://github.com/jaknowlden/calendar_builder/commit/c5102ae881f812801fcd95ab104b9ea3c4b83a1d'>tweaks to the yields and blocks</a> and we were back on track.</p>

<p>Sent them a pull request. They&#8217;re very cool guys who respond pretty quickly; in case your anxious to get ahold of the latest copy.</p>

<p>Also ran into a <code>sqlite3</code> problem running their tests, but this time I only had to add this to their test helper:</p>

<pre><code>gem `sqlite3-ruby`</code></pre>

<h3 id='routes'>Routes</h3>

<p>OMG. Just when I thought I was done; you know &#8230; because all the tests were passing. I started the app up, sent my browser to <code>http://localhost:3000/</code> and &#8230; 405 error:</p>

<pre><code>Only post requests are allowed
...
vendor/rails/actionpack/lib/action_controller/routing/recognition_optimisation.rb:64:in `recognize_path&#39;</code></pre>

<p>WTF? What now? Nothing had changed in our routes or anything. The last couple lines of our routes.rb looked like this:</p>

<pre><code>  ...
  map.resource :session
  map.resource :dashboard
  map.root :dashboard
  map.connect &#39;:controller/:action/:id&#39;
end</code></pre>

<p>Worked before. <code>http://localhost:3000/</code> should be trying to hit <code>DashboardsController#show</code> and then be redirected to <code>SessionsController#new</code> for not being logged in.</p>

<p>Hmmm &#8230;</p>

<p>More hacking around. <code>http://localhost:3000/dashboard</code> works fine and does the redirect. <code>http://localhost:3000/session/new</code> does what it&#8217;s supposed to, show the login page. Reading, reading, reading &#8230; nothing. Tried watching the logs, but it only errored without telling me what it was trying to render.</p>

<p>On an absolute whim, I wondered &#8220;What if it&#8217;s not even hitting show?&#8221; The documentation never said anything about a routes change, but hey &#8230; Rails documentation isn&#8217;t the best. So, seriously on a whim, out of nowhere, for no reason but to try, I made this one change:</p>

<pre><code>map.resource :dashboard, :only =&gt; [:show]</code></pre>

<p>Holy f&#8217;ing crap! It worked. Back to normal. Whew &#8230; <code>hg commit &amp;&amp; hg push</code>. Yeah, we&#8217;re using <a href='http://www.selenic.com/mercurial/wiki/'>Mercurial</a>.</p>

<h3 id='summary'>Summary</h3>

<p>I don&#8217;t know. I guess this is normal behavior. Maybe some suggestions:</p>

<ul>
<li>Get the stuff done you were trying to get done before you upgrade :(</li>

<li>Make sure you have upgraded every single one of your dependencies and make sure you haven&#8217;t frozen anything to an older version &#8230; else you&#8217;ll be chasing your tail</li>
</ul>

<h3 id='update'>Update</h3>

<ol>
<li>We&#8217;re not using Mercurial anymore. We moved to git and are hosting on GitHub (private ya&#8217;ll).</li>
</ol>
</div>


    </div>
    <div class='container'>
      <div class='clear' id='footer'>
        &copy; 2007 - 2009 Justin Knowlden,
        <span class='email'>gus at gusg dot us</span>
        <span class='powered'>
          - Powered by <a href=''>Jekyll</a>,
          <a href='http://daringfireball.net/projects/markdown/'>Markdown</a>,
          <a href='http://pygments.org/'>Pygments</a>, and me
        </span>
        <!-- <a href="http://feeds2.feedburner.com/gusgus" rel="alternate" type="application/rss+xml">
          <img src="http://www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt="" style="vertical-align:middle;border:0"/></a> -->
      </div>
    </div>
    <script src="http://ajax.googleapis.com/ajax/libs/prototype/1.6.0.3/prototype.js" type="text/javascript"></script>
    <script src="/javascripts/jquery-1.2.6.min.js" type="text/javascript"></script>
    <script src="http://grumble.annealer.org/javascripts/grumbler/api.js" type="text/javascript"></script>
    <script src="/javascripts/grumble_support.js" type="text/javascript"></script>
  </body>
</html>