<?xml version='1.0' encoding='utf-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <head>
    <meta content='GROW UP' http-equiv='X-UA-Compatible' />
    <meta content='width=960' name='viewport' />
    <title>The Knowldenist - Drink Up! - Assert Session</title>
    <link href='/images/gusgus_icon.gif' rel='icon' />
    <link href="http://feeds.feedburner.com/gusgus" rel="alternate" title="The Knowldenist" type="application/atom+xml" />
    <link href='http://gusg.us/feed.xml' rel='alternate' title='The Knowldenist' type='application/atom+xml' />
    <link href="/stylesheets/reset.css" type="text/css" media="screen" rel="stylesheet"/>
    <link href="/stylesheets/960.css" type="text/css" media="screen" rel="stylesheet"/>
    <link href="/stylesheets/text.css" type="text/css" media="screen" rel="stylesheet"/>
    <link href="/stylesheets/application.css" type="text/css" media="screen" rel="stylesheet"/>
    <link href="/stylesheets/pygment-native.css" type="text/css" media="screen" rel="stylesheet"/>
  </head>

  <body>
    <div class='container_12'>
      <div id='header'>
        <div id="title" class="grid_4 alpha">
          <span class="article">The</span><span class="noun"><a href="/">Knowldenist</a></span>
        </div>
        <div id="nav" class="grid_8 omega">
          <ul>
            <li>
              Read
              <ul><li><a href="/">Home</a></li></ul>
            </li>
            <li>
              Blurp!
              <ul><li><a href="/blurp/">Excuse me</a></li></ul>
            </li>
            <li>
              Code
              <ul>
                <li><a href="http://github.com/jaknowlden">jaknowlden</a></li>
                <li><a href="http://github.com/thumblemonks">thumblemonks</a></li>
              </ul>
            </li>
            <li>
              Links
              <ul>
                <li><a href="http://tumblr.gusg.us/">Tumblr</a></li>
                <li><a href="http://twitter.com/jaknowlden">Twittr</a></li>
                <li><a href="http://flickr.com/jaknowlden">Flickr</a></li>
              </ul>
            </li>
          </ul>
        </div>
      </div>

      <div id="main" class='grid_12 alpha omega'>
        <div id="page_title">
  <h1>Assert Session</h1>
  <div class="summary"><em>Extending Assert Request</em></div>
</div>

<div class="grid_9 alpha">
  <div id="left" class="grid_3 alpha column">
    <ul>
      <h3>Into the Future</h3>
      <li>
        <a href="/life/active-record-modeling-life.html">Active Record Modeling Life</a>
        <p><em>Code and Life intertwined ... ewwwwww</em></p>
      </li>

      <li>
        <a href="/code/ruby/flashback.html">Flashback</a>
        <p><em>Test your flash and I mean .now</em></p>
      </li>
    </ul>
  </div>

  <div id="article" class="grid_6 omega">
    <div id="info">
      <div class="date"><cite>Jan 08, 2008</cite></div>
    </div>

    <div class="content"><p>I was coding along in Rails with security in mind using the simple <a href='http://validaterequest.rubyforge.org/'>Assert Request</a> plugin from <a href='http://workingwithrails.com/person/5938-scott-woods'>Scott A Woods</a> in my controllers and ran into a spot where I wanted to require the presence of a session variable before allowing the rest of an action to execute. The specific motivation was conceived when coding a controller for an invitation mechanism. Normally, a user invites another user to a system, the invited user comes to the system with their invite-code (probably from a link in an email), completes some form (let&#8217;s call it invite-accept), and then submits the final request (invite-update).</p>

<p>What I didn&#8217;t want was an easy way for a user to be able to by-pass the invite-accept and go straight to invite-update. To prevent this, I wanted the invite-code to be available to invite-update, but not via a parameter. The quickest and safest way I could think was to require that it be in the session, which would theoretically force the user to first visit invite-accept. This way, only invited people can accept invites and they must go through invite-accept.</p>

<p>I also really liked the convention of using <code>assert_request</code> at the head of each of my actions (I even implemented an <code>assert_request_has_no_params</code> helper for most of them) and I didn&#8217;t want to break from it to do a:</p>
<div class='highlight'><pre><code class='ruby'><span class='k'>def</span> <span class='nf'>some_action</span>
  <span class='k'>raise</span> <span class='no'>Exception</span> <span class='k'>unless</span> <span class='n'>session</span><span class='o'>[</span><span class='ss'>:invite_code</span><span class='o'>]</span>
  <span class='c1'># ...</span>
<span class='k'>end</span>
</code></pre>
</div>
<h2 id='interpretation'>Interpretation</h2>

<p>So, I wrote an extension to <code>AssertRequest</code> called - oddly enough - <code>AssertSession</code>. It&#8217;s not complex and looks very similar to existing <code>AssertRequest</code> code. It currently supports two directives:</p>

<ul>
<li><code>:must_have</code> - Requires the existence of declared session variable(s) or an error is raised</li>

<li><code>:may_have</code> - Allows for the existence of declared session variable(s)</li>
</ul>

<p>The following code example shows how one might require the existence of three session variables for the given request: <code>:baz</code>, <code>:bum</code>, and <code>:bar</code></p>
<div class='highlight'><pre><code class='ruby'><span class='k'>class</span> <span class='nc'>FooController</span> <span class='o'>&lt;</span> <span class='no'>ApplicationController</span>
  <span class='k'>def</span> <span class='nf'>bar</span>
    <span class='n'>assert_session</span> <span class='p'>{</span><span class='o'>|</span><span class='n'>rule</span><span class='o'>|</span> <span class='n'>rule</span><span class='o'>.</span><span class='n'>must_have</span> <span class='ss'>:baz</span><span class='p'>,</span> <span class='ss'>:bum</span><span class='p'>,</span> <span class='ss'>:bar</span><span class='p'>}</span>
  <span class='k'>end</span>
<span class='k'>end</span>
</code></pre>
</div>
<p>If any one of the session variables does not exist in the session at the time the request is processed, a <code>AssertRequest::RequestError</code> exception is raised with a meaningful error message; like:</p>
<div class='highlight'><pre><code class='ruby'><span class='s2'>&quot;:baz and :bar expected to be in session&quot;</span>
</code></pre>
</div>
<p>What if you only wanted to require <code>:baz</code>, but you wanted to allow for <code>:boo</code> and <code>:bar</code>?</p>
<div class='highlight'><pre><code class='ruby'><span class='k'>class</span> <span class='nc'>FooController</span> <span class='o'>&lt;</span> <span class='no'>ApplicationController</span>
  <span class='k'>def</span> <span class='nf'>bar</span>
    <span class='n'>assert_session</span> <span class='k'>do</span> <span class='o'>|</span><span class='n'>rule</span><span class='o'>|</span>
      <span class='n'>rule</span><span class='o'>.</span><span class='n'>must_have</span> <span class='ss'>:baz</span>
      <span class='n'>rule</span><span class='o'>.</span><span class='n'>may_have</span> <span class='ss'>:boo</span><span class='p'>,</span> <span class='ss'>:bar</span>
    <span class='k'>end</span>
  <span class='k'>end</span>
<span class='k'>end</span>
</code></pre>
</div>
<p>For this example, an error will only be thrown if <code>:baz</code> is not defined at the time of the request. <code>:boo</code> and <code>:bar</code> may or may not be defined. This was useful for me to allow session variables that might have been stored during login actions, like a <code>return_to</code> <em>(though, in this case, it might be more prudent to allow a global ignore style declaration)</em>.</p>

<p>In addition, any variable found in the session that is not declared as a <code>must_have</code> or a <code>may_have</code> is considered malicious and a <code>AssertRequest::RequestError</code> exception is raised with a meaningful error message. For instance, given either of the above examples, the request will be halted and an error with the following message raised if a session variable is defined named <code>:toothrot</code>.</p>
<div class='highlight'><pre><code class='ruby'><span class='s2'>&quot;:toothrot not expected to be in session&quot;</span>
</code></pre>
</div>
<p>By default, <code>AssertSession</code> will ignore the variable named <code>flash</code> in the session.</p>

<p><code>AssertSession</code> works right along <code>AssertRequest</code>, but cannot be called from within an <code>assert_request</code> block.</p>

<h2 id='application'>Application</h2>

<p>Back to the original motivation; the invitations controller. After having implemented <code>assert_session</code>, I was able to use it in the controller like so:</p>
<div class='highlight'><pre><code class='ruby'><span class='k'>class</span> <span class='nc'>InvitesController</span> <span class='o'>&lt;</span> <span class='no'>ApplicationController</span>
  <span class='c1'># ...</span>
  <span class='k'>def</span> <span class='nf'>accept</span>
    <span class='n'>assert_request</span> <span class='p'>{</span> <span class='o'>|</span><span class='n'>r</span><span class='o'>|</span> <span class='n'>r</span><span class='o'>.</span><span class='n'>params</span><span class='o'>.</span><span class='n'>must_have</span> <span class='ss'>:invite_code</span> <span class='p'>}</span>
    <span class='vi'>@user</span> <span class='o'>=</span> <span class='no'>User</span><span class='o'>.</span><span class='n'>find_invited</span><span class='p'>(</span><span class='n'>params</span><span class='o'>[</span><span class='ss'>:invite_code</span><span class='o'>]</span><span class='p'>)</span>
    <span class='n'>session</span><span class='o'>[</span><span class='ss'>:invite_code</span><span class='o'>]</span> <span class='o'>=</span> <span class='n'>params</span><span class='o'>[</span><span class='ss'>:invite_code</span><span class='o'>]</span>
  <span class='k'>rescue</span> <span class='no'>ActiveRecord</span><span class='o'>::</span><span class='no'>RecordNotFound</span>
    <span class='n'>bad_request</span><span class='p'>(</span><span class='s1'>&#39;The invite code you provided is invalid.&#39;</span><span class='p'>)</span>
  <span class='k'>end</span>

  <span class='k'>def</span> <span class='nf'>update</span>
    <span class='n'>assert_session</span> <span class='p'>{</span> <span class='o'>|</span><span class='n'>s</span><span class='o'>|</span> <span class='n'>s</span><span class='o'>.</span><span class='n'>must_have</span><span class='p'>(</span><span class='ss'>:invite_code</span><span class='p'>);</span> <span class='n'>s</span><span class='o'>.</span><span class='n'>may_have</span><span class='p'>(</span><span class='ss'>:return_to</span><span class='p'>)</span> <span class='p'>}</span>
    <span class='n'>assert_post</span> <span class='k'>do</span> <span class='o'>|</span><span class='n'>r</span><span class='o'>|</span>
      <span class='n'>r</span><span class='o'>.</span><span class='n'>params</span><span class='o'>.</span><span class='n'>must_have</span><span class='p'>(</span><span class='ss'>:user</span><span class='p'>)</span> <span class='p'>{</span> <span class='o'>|</span><span class='n'>u</span><span class='o'>|</span> <span class='n'>u</span><span class='o'>.</span><span class='n'>must_have</span><span class='p'>(</span><span class='ss'>:name</span><span class='p'>,</span> <span class='ss'>:password</span><span class='p'>,</span>
        <span class='ss'>:password_confirmation</span><span class='p'>)}</span>
    <span class='k'>end</span>
    <span class='c1'># ...</span>
  <span class='k'>end</span>
<span class='k'>end</span>
</code></pre>
</div>
<p>The <code>:return_to</code> should really only be present if you&#8217;ve ever tried to login, but since I do a lot of playing in the interface, I would routinely hit the problem where <code>:return_to</code> existed and I didn&#8217;t really feel like clearing my sessions (<code>:return_to</code> comes with <code>acts_as_authenticated</code>).</p>

<p><code>assert_post</code> is another helper I wrote which simply does an <code>assert_request</code>, requires the method to be a POST, and then yields. Like this:</p>
<div class='highlight'><pre><code class='ruby'><span class='k'>def</span> <span class='nf'>assert_post</span><span class='p'>(</span><span class='o'>&amp;</span><span class='n'>block</span><span class='p'>)</span>
  <span class='n'>assert_request</span> <span class='k'>do</span> <span class='o'>|</span><span class='n'>rules</span><span class='o'>|</span>
    <span class='n'>rules</span><span class='o'>.</span><span class='n'>method</span> <span class='ss'>:post</span>
    <span class='k'>yield</span> <span class='n'>rules</span>
  <span class='k'>end</span>
<span class='k'>end</span>
</code></pre>
</div>
<p>A cooler approach would be if <code>assert_request</code> itself was modified to accept the required HTTP method as an argument. An example of use would be:</p>
<div class='highlight'><pre><code class='ruby'><span class='n'>assert_request</span><span class='p'>(</span><span class='ss'>:post</span><span class='p'>)</span> <span class='p'>{</span><span class='o'>.</span><span class='n'>.</span><span class='o'>.</span><span class='p'>}</span> <span class='c1'># What do you think, Scott?</span>
</code></pre>
</div>
<h2 id='installation'>Installation</h2>

<p>First, install the <code>AssertRequest</code> plugin.</p>
<div class='highlight'><pre><code class='ruby'><span class='n'>ruby</span> <span class='n'>script</span><span class='o'>/</span><span class='n'>plugin</span> <span class='n'>install</span> <span class='n'>svn</span><span class='ss'>:/</span><span class='o'>/</span><span class='n'>rubyforge</span><span class='o'>.</span><span class='n'>org</span><span class='o'>/</span><span class='n'>var</span><span class='o'>/</span><span class='n'>svn</span><span class='o'>/</span><span class='n'>validaterequest</span><span class='o'>/</span><span class='n'>plugins</span><span class='o'>/</span><span class='n'>assert_request</span>
</code></pre>
</div>
<p>Second, create a file using the code below in your Rails application and require it in your <code>environment.rb</code> file. When Scott Woods accepts the patch, you can simply install/update the plugin you have installed.</p>

<h2 id='code'>Code</h2>

<p>Until Scott Woods adds the code into the plugin, the code only exists here.</p>
<div class='highlight'><pre><code class='ruby'><span class='k'>module</span> <span class='nn'>Glomp</span> <span class='c1'>#:nodoc:</span>
  <span class='k'>module</span> <span class='nn'>AssertRequest</span> <span class='c1'>#:nodoc:</span>
    <span class='k'>module</span> <span class='nn'>PublicMethods</span> <span class='c1'>#:nodoc:</span>
      <span class='k'>def</span> <span class='nf'>assert_session</span>
        <span class='n'>rules</span> <span class='o'>=</span> <span class='no'>SessionRules</span><span class='o'>.</span><span class='n'>new</span>
        <span class='k'>yield</span> <span class='n'>rules</span>
        <span class='n'>rules</span><span class='o'>.</span><span class='n'>validate</span><span class='p'>(</span><span class='n'>session</span><span class='p'>)</span>
      <span class='k'>end</span>
    <span class='k'>end</span> <span class='c1'># PublicMethods</span>
  
    <span class='k'>class</span> <span class='nc'>SessionRules</span>
      <span class='k'>def</span> <span class='nf'>initialize</span>
        <span class='vi'>@required</span> <span class='o'>=</span> <span class='o'>[]</span>
        <span class='vi'>@ignore_vars</span> <span class='o'>=</span> <span class='o'>[</span><span class='s1'>&#39;flash&#39;</span><span class='o'>]</span>
      <span class='k'>end</span>

      <span class='k'>def</span> <span class='nf'>must_have</span><span class='p'>(</span><span class='o'>*</span><span class='n'>args</span><span class='p'>)</span>
        <span class='vi'>@required</span><span class='o'>.</span><span class='n'>concat</span><span class='p'>(</span><span class='n'>args</span><span class='p'>)</span><span class='o'>.</span><span class='n'>flatten!</span>
        <span class='nb'>self</span>
      <span class='k'>end</span>

      <span class='k'>def</span> <span class='nf'>may_have</span><span class='p'>(</span><span class='o'>*</span><span class='n'>args</span><span class='p'>)</span>
        <span class='vi'>@ignore_vars</span><span class='o'>.</span><span class='n'>concat</span><span class='p'>(</span><span class='n'>args</span><span class='p'>)</span><span class='o'>.</span><span class='n'>flatten!</span>
        <span class='nb'>self</span>
      <span class='k'>end</span>

      <span class='k'>def</span> <span class='nf'>validate</span><span class='p'>(</span><span class='n'>session</span><span class='p'>)</span>
        <span class='n'>cats</span> <span class='o'>=</span> <span class='p'>{</span><span class='ss'>:expected</span> <span class='o'>=&gt;</span> <span class='o'>[]</span><span class='p'>,</span> <span class='ss'>:unexpected</span> <span class='o'>=&gt;</span> <span class='o'>[]</span><span class='p'>,</span> <span class='ss'>:matched</span> <span class='o'>=&gt;</span> <span class='o'>[]</span><span class='p'>}</span>
        <span class='n'>session</span><span class='o'>.</span><span class='n'>data</span><span class='o'>.</span><span class='n'>each</span> <span class='k'>do</span> <span class='o'>|</span><span class='n'>k</span><span class='p'>,</span><span class='n'>v</span><span class='o'>|</span>
          <span class='n'>cat</span> <span class='o'>=</span> <span class='vi'>@required</span><span class='o'>.</span><span class='n'>index</span><span class='p'>(</span><span class='n'>k</span><span class='p'>)</span> <span class='p'>?</span> <span class='p'>(</span><span class='o'>!</span><span class='n'>v</span> <span class='p'>?</span> <span class='ss'>:expected</span> <span class='p'>:</span> <span class='ss'>:matched</span><span class='p'>)</span> <span class='p'>:</span> <span class='ss'>:unexpected</span>
          <span class='n'>cats</span><span class='o'>[</span><span class='n'>cat</span><span class='o'>]</span> <span class='o'>&lt;&lt;</span> <span class='n'>k</span>
        <span class='k'>end</span>
        <span class='n'>cats</span><span class='o'>[</span><span class='ss'>:expected</span><span class='o'>]</span> <span class='o'>+=</span> <span class='vi'>@required</span> <span class='o'>-</span> <span class='n'>cats</span><span class='o'>[</span><span class='ss'>:matched</span><span class='o'>]</span>
        <span class='k'>if</span> <span class='o'>!</span><span class='n'>cats</span><span class='o'>[</span><span class='ss'>:expected</span><span class='o'>].</span><span class='n'>empty?</span>
          <span class='k'>raise</span> <span class='o'>::</span><span class='no'>AssertRequest</span><span class='o'>::</span><span class='no'>RequestError</span><span class='p'>,</span>
            <span class='s2'>&quot;</span><span class='si'>#{</span><span class='n'>cats</span><span class='o'>[</span><span class='ss'>:expected</span><span class='o'>].</span><span class='n'>to_sentence</span><span class='si'>}</span><span class='s2'> expected to be in session&quot;</span>
        <span class='k'>elsif</span> <span class='o'>!</span><span class='p'>(</span><span class='n'>cats</span><span class='o'>[</span><span class='ss'>:unexpected</span><span class='o'>]</span> <span class='o'>-=</span> <span class='vi'>@ignore_vars</span><span class='p'>)</span><span class='o'>.</span><span class='n'>empty?</span>
          <span class='k'>raise</span> <span class='o'>::</span><span class='no'>AssertRequest</span><span class='o'>::</span><span class='no'>RequestError</span><span class='p'>,</span>
            <span class='s2'>&quot;</span><span class='si'>#{</span><span class='n'>cats</span><span class='o'>[</span><span class='ss'>:unexpected</span><span class='o'>].</span><span class='n'>to_sentence</span><span class='si'>}</span><span class='s2'> not expected to be in session&quot;</span>
        <span class='k'>end</span>
      <span class='k'>end</span>
    <span class='k'>end</span>
  
  <span class='k'>end</span> <span class='c1'># AssertRequest</span>
<span class='k'>end</span> <span class='c1'># Glomp</span>

<span class='no'>ActionController</span><span class='o'>::</span><span class='no'>Base</span><span class='o'>.</span><span class='n'>send</span><span class='p'>(</span><span class='ss'>:include</span><span class='p'>,</span> <span class='no'>Glomp</span><span class='o'>::</span><span class='no'>AssertRequest</span><span class='o'>::</span><span class='no'>PublicMethods</span><span class='p'>)</span>
</code></pre>
</div>
<p>Tests are available upon request.</p></div>
  </div>

  
  <div id="grumble">
    <h4 class="count"></h4>
    <ul></ul>

    <div id="disqus_thread"></div>
    <script type="text/javascript" src="http://disqus.com/forums/gusgus/embed.js"></script>
    <noscript><a href="http://disqus.com/forums/gusgus/?url=ref">View the discussion thread.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">powered by <span class="logo-disqus">Disqus</span></a>
  </div>
  
</div>

<div id="right" class="grid_3 omega column">
  <ul>
    <h3>Into the Past</h3>
    <li>
      <a href="/code/ruby/full-on-errors.html">Full on Errors</a>
      <p><em>Rails plugin to get the full error message for a specific ActiveRecord attribute</em></p>
    </li>

    <li>
      <a href="/code/password-sophistication.html">Password Sophistication</a>
      <p><em>My implementation of a web-based password strength meter</em></p>
    </li>

    <p><em>
      Check out these fine products:
      <a href="http://ackandnak.com/">Ack &amp; Nak</a> many-days-a-week web comic,
      <a href="http://dailyjs.com/">DailyJS</a>,
      <a href="http://helicoid.net/">Helicoid</a>,
      <a href="http://swirrl.com/">Swirrl</a>,
      <a href="http://javagems.org/">Java Gems</a>, et al
    </em></p>
  </ul>
</div>

      </div>

      <div class='grid_12 alpha omega' id='footer'>
        <a href="http://feeds2.feedburner.com/gusgus" rel="alternate" type="application/rss+xml">
          <img src="http://www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt="" style="vertical-align:middle;border:0"/></a>
        &copy; 2007 -  Justin Knowlden /
        <span id="other_thumble_monks">
          Other Thumble Monks:
          <a href="http://annealer.org/">Annealer</a>,
          <a href="http://github.com/danhodos">Sandman</a>,
          <a href="http://toothrot.net/">Toothrot</a>,
          <a href="http://hjstudios.com/">JankStar</a>,
          <a href="http://andrijevik.net/">Vladka</a>
        </span>
      </div>
    </div>

    <script src="/javascripts/jquery-1.3.2.min.js"></script>
    <script src="/javascripts/disqus.js"></script>
    <script src="/javascripts/application.js"></script>
    <script src="/javascripts/ga.js"></script>
  </body>
</html>