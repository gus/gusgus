<?xml version='1.0' encoding='utf-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <head>
    <meta content='GROW UP' http-equiv='X-UA-Compatible' />
    <meta content='width=960' name='viewport' />
    <title>The Knowldenist - Drink Up! - Smurf</title>
    <link href='/images/gusgus_icon.gif' rel='icon' />
    <link href="http://feeds.feedburner.com/gusgus" rel="alternate" title="The Knowldenist" type="application/atom+xml" />
    <link href='http://gusg.us/feed.xml' rel='alternate' title='The Knowldenist' type='application/atom+xml' />
    <link href="/stylesheets/reset.css" type="text/css" media="screen" rel="stylesheet"/>
    <link href="/stylesheets/960.css" type="text/css" media="screen" rel="stylesheet"/>
    <link href="/stylesheets/text.css" type="text/css" media="screen" rel="stylesheet"/>
    <link href="/stylesheets/application.css" type="text/css" media="screen" rel="stylesheet"/>
    <link href="/stylesheets/pygment-native.css" type="text/css" media="screen" rel="stylesheet"/>
  </head>

  <body>
    <div class='container_12'>
      <div id='header'>
        <div id="title" class="grid_4 alpha">
          <span class="article">The</span><span class="noun"><a href="/">Knowldenist</a></span>
        </div>
        <div id="nav" class="grid_8 omega">
          <ul>
            <li>
              Read
              <ul><li><a href="/">Home</a></li></ul>
            </li>
            <li>
              Blurp!
              <ul><li><a href="/blurp/">Excuse me</a></li></ul>
            </li>
            <li>
              Code
              <ul>
                <li><a href="http://github.com/jaknowlden">jaknowlden</a></li>
                <li><a href="http://github.com/thumblemonks">thumblemonks</a></li>
              </ul>
            </li>
            <li>
              Links
              <ul>
                <li><a href="http://tumblr.gusg.us/">Tumblr</a></li>
                <li><a href="http://twitter.com/jaknowlden">Twittr</a></li>
                <li><a href="http://flickr.com/jaknowlden">Flickr</a></li>
              </ul>
            </li>
          </ul>
        </div>
      </div>

      <div id="main" class='grid_12 alpha omega'>
        
<div id="page_title">
  <h1>Smurf</h1>
  <div class="summary"><em>Rails Javascript & CSS Auto-minifying plugin</em></div>
</div>

<div class="grid_9 alpha">
  <div id="left" class="grid_3 alpha column">
    <ul>
      <h3>Into the Future</h3>
      <li>
        <a href="/code/erlang/erlang-diaries-vol1.html">Erlang Diaries - Vol 1</a>
        <p><em>Brought to you by the lower-case letter 'c'</em></p>
      </li>

      <li>
        <a href="/code/ruby/shoulda-making-dry-even-dryier.html">Shoulda: Making DRY even DRY-ier</a>
        <p><em>A look at how I build shoulda macros</em></p>
      </li>

    <h3>Check me out!</h3>
      <p><em>
        <a href="http://github.com/thumblemonks/riot">Riot</a> for fast ruby testing,
        <a href="http://jubilator.thumblemonks.com/" title="Browse GitHub in style">Jubilator</a> for GitHub browsing,
        <a href="http://seota.thumblemonks.com/" title="Semi-automatic SEO assistance">Seota</a> for semi-automatic SEO help,
        <a href="http://github.com/thumblemonks/animalcracker">Animal Cracker</a> for Rack asset hosting assistance,
        <a href="http://github.com/thumblemonks/riot">Chicago</a> for Sinatra helpers
      </em></p>
    </ul>
  </div>

  <div id="article" class="grid_6 omega">
    <div id="info">
      <div class="date"><cite>Nov 08, 2008</cite></div>
    </div>

    <div class="content"><img src='/images/articles/code/ruby/mini-thor.jpg' height='250' align='left' width='250' />
<blockquote>
<p><em><a href='http://github.com/thumblemonks/smurf'>Smurf</a> can be found on Git Hub :)</em></p>
</blockquote>

<p>You know how Rails 2.x has this cool feature for bundling sets of Javascript or CSS files? Yeah, they call it something like &#8230; <code>cache</code>. Crazy. I know. It&#8217;s cool and all, but why does not it also minify that content? I mean, it&#8217;s not like the content is going to change. You&#8217;re only really going to be using this caching approach in production. Why couldn&#8217;t it just do the minification on the big, concatenated file before it saved it?</p>

<p>Not understanding it, I went in search of those plugins which would do just what I want. I just knew they were out there. They were:</p>

<ol>
<li>Not going to make me do anything else than use <code>:cache</code> in my <code>include</code> and <code>link</code> tags</li>

<li>Not going make me turn any features on or setup any configuration do-hickeys</li>

<li>Would minify Javascript and CSS</li>

<li>Just going to minify content</li>
</ol>

<p>Yeah. No. Nothing to meet that criteria. I did find a <a href='http://github.com/sbecker/asset_packager/tree/master'>few</a> <a href='http://github.com/timcharper/bundle-fu/tree/master'>implementations</a>. A <a href='http://sneer.org'>friend</a> also turned me onto a <a href='http://github.com/lucianopanaro/rack-javascript-minifier/tree/master'>Rack minifier</a> which does make a lot of sense, if you&#8217;re running Rack. But, nothing that just did what I wanted.</p>

<p>So, as I&#8217;ve told others, if you&#8217;re going to be a critic you should at least try to do better. Ergo, <a href='http://github.com/thumblemonks/smurf'>Smurf</a>.</p>

<h2 id='what_does_it_do'>What does it do?</h2>

<p>I did a little digging into Rails to find out how I could get what I want. It didn&#8217;t take all that long. Just look in <code>ActionView::Helpers::AssetTagHelper</code> for a private method called <code>join_asset_file_contents</code>. This is the method that takes a list of files, joins their contents together and returns the concatenated content.</p>

<p>Whoa. That&#8217;s what I want! All of the content together. In one stream. With that, I can just run the combined content through an appropriate minifier.</p>

<p>And I did. I found Uladzislau Latynski&#8217;s <a href='http://javascript.crockford.com/jsmin.rb'>jsmin.rb</a>, which is a port of Douglas Crockford&#8217;s <a href='http://javascript.crockford.com/jsmin.c'>jsmin.c</a> library. I adapted Uladzislau&#8217;s code a little and suddenly had a JS minifier.</p>

<p>But, what about a CSS minifier? I looked around a little, but nothing stood out as elegant, so I rolled my own. It may not be the best, but it&#8217;s short and I can actually read what it&#8217;s doing. For example, here&#8217;s how I compress a stream of CSS:</p>

<pre><code>content.compress_whitespace.remove_comments.remove_spaces_outside_block.
  remove_spaces_inside_block.trim_last_semicolon</code></pre>

<p>You&#8217;ll just have to <a href='http://github.com/thumblemonks/smurf/tree/master/lib/smurf/stylesheet.rb'>look at the code</a> to see how I do it. SPOILER ALERT: I do it with regular expressions! <em>(use your high-pitched theatrical voice for that part)</em></p>

<p>Because I Hijack (that&#8217;s my contribution to software patterns &#8230; Hijacking) the nifty Rails method that returns content and just return minified content, I don&#8217;t need to do any friggin&#8217; thing else. And neither do you.</p>

<p>Install the plugin and you&#8217;re done. Hell yeah!</p>

<pre><code>./script/plugin install git://github.com/thumblemonks/smurf.git</code></pre>

<p>Make sure you have this in at least your <code>production.rb</code>:</p>

<pre><code>config.action_controller.perform_caching = true</code></pre>

<p>And then make sure you are using the <code>:cache</code> option with your <code>javascript_include_tag</code> and <code>stylesheet_link_tag</code> statements.</p>

<h2 id='miscellany'>Miscellany</h2>

<p>I suggest <a href='http://maintainable.com/articles/rails_asset_cache'>this</a> approach for cleaning up cached files if you need to do it for testing.</p>

<p>However, a simple <code>cap deploy</code> will &#8220;get rid of&#8221; of any cached files you have in production.</p>

<h2 id='references'>References</h2>

<ol>
<li><a href='http://www.robertcasumbal.com/blog/?p=114'>Mini Thor</a> - Drawing by <a href='http://www.robertcasumbal.com/'>Robert Casumbal</a></li>
</ol></div>
  </div>

  
  <div id="grumble">
    <h4 class="count"></h4>
    <ul></ul>

    <div id="disqus_thread"></div>
    <script type="text/javascript" src="http://disqus.com/forums/gusgus/embed.js"></script>
    <noscript><a href="http://disqus.com/forums/gusgus/?url=ref">View the discussion thread.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">powered by <span class="logo-disqus">Disqus</span></a>
  </div>
  
</div>

<div id="right" class="grid_3 omega column">
  <ul>
    <h3>Into the Past</h3>
    <li>
      <a href="/life/me-me-meme.html">The Me Me Meme</a>
      <p><em>Me me meme memememe me mme meme</em></p>
    </li>

    <li>
      <a href="/code/ruby/dumb-smtp.html">Dumb SMTP</a>
      <p><em>The Reaffirming SMTP Server</em></p>
    </li>

    <p><em>
      Check out these fine products:
      <a href="http://ackandnak.com/">Ack &amp; Nak</a> many-days-a-week web comic,
      <a href="http://dailyjs.com/">DailyJS</a>,
      <a href="http://helicoid.net/">Helicoid</a>,
      <a href="http://swirrl.com/">Swirrl</a>,
      <a href="http://javagems.org/">Java Gems</a>, et al
    </em></p>
  </ul>
</div>

      </div>

      <div class='grid_12 alpha omega' id='footer'>
        <a href="http://feeds2.feedburner.com/gusgus" rel="alternate" type="application/rss+xml">
          <img src="http://www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt="" style="vertical-align:middle;border:0"/></a>
        &copy; 2007 -  Justin Knowlden /
        <span id="other_thumble_monks">
          Other Thumble Monks:
          <a href="http://annealer.org/">Annealer</a>,
          <a href="http://github.com/danhodos">Sandman</a>,
          <a href="http://toothrot.net/">Toothrot</a>,
          <a href="http://hjstudios.com/">JankStar</a>,
          <a href="http://andrijevik.net/">Vladka</a>
        </span>
      </div>
    </div>

    <script src="/javascripts/disqus.js"></script>
    <script src="/javascripts/ga.js"></script>
  </body>
</html>