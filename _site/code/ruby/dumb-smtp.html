<?xml version='1.0' encoding='utf-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <head>
    <meta content='GROW UP' http-equiv='X-UA-Compatible' />
    <meta content='width=850' name='viewport' />
    <title>The Knowldenist - Drink Up! - Dumb SMTP</title>
    <link href='/images/gusgus_icon.gif' rel='icon' />
    <link href="http://feeds.feedburner.com/gusgus" rel="alternate" title="The Knowldenist" type="application/atom+xml" />
    <link href='http://gusg.us/feed.xml' rel='alternate' title='The Knowldenist' type='application/atom+xml' />
    <link href="/stylesheets/reset.css" type="text/css" media="screen" rel="stylesheet"/>
    <link href="/stylesheets/960.css" type="text/css" media="screen" rel="stylesheet"/>
    <link href="/stylesheets/text.css" type="text/css" media="screen" rel="stylesheet"/>
    <link href="/stylesheets/application.css" type="text/css" media="screen" rel="stylesheet"/>
    <link href="/stylesheets/pygment-native.css" type="text/css" media="screen" rel="stylesheet"/>
  </head>

  <body>
    <div class='container_12'>
      <div id='header' class='grid_12 alpha omega'>
        <div id="title" class="grid_6 alpha">
          <span class="article">The</span><span class="noun"><a href="/">Knowldenist</a></span>
        </div>
        <div id="nav" class="grid_6 omega">
          <ul>
            <li><a href='/'>Read</a></li>
            <li>
              Code
              <ul>
                <li><a href="http://github.com/jaknowlden">jaknowlden</a></li>
                <li><a href="http://github.com/thumblemonks">thumblemonks</a></li>
              </ul>
            </li>
            <li>
              Links
              <ul>
                <li><a href="http://tumblr.gusg.us/">Tumblr</a></li>
                <li><a href="http://twitter.com/jaknowlden">Twittr</a></li>
                <li><a href="http://flickr.com/jaknowlden">Flickr</a></li>
              </ul>
            </li>
          </ul>
        </div>
      </div>

      <div id="main" class='grid_12 alpha omega'>
        <div id="page_title">
  <h1>Dumb SMTP</h1>
  <div class="summary"><em>The Reaffirming SMTP Server</em></div>
</div>

<div id="left" class="grid_3 alpha column">
  <ul>
    <h3>Into the Future</h3>
    <li>
      <a href="/code/ruby/smurf-rails-autominifying-js-css-plugin.html">Smurf</a>
      <p><em>Rails Javascript & CSS Auto-minifying plugin</em></p>
    </li>

    <li>
      <a href="/life/me-me-meme.html">The Me Me Meme</a>
      <p><em>Me me meme memememe me mme meme</em></p>
    </li>
  </ul>
</div>

<div id="article" class="grid_6">
  <div id="info">
    <div class="date"><cite>Nov 08, 2008</cite></div>
  </div>

  <div class="content"><p>I saw this post about a <a href='http://d.hatena.ne.jp/koseki2/20081030/mocksmtpd'>Mock SMTP</a> server off of <a href='http://rubyflow.com'>RubyFlow</a> today and it scared the living crap out of me. You bet it did! Is that what a mock of something is considered to be?</p>

<p>In response, I&#8217;m attaching the code for a dumb SMTP server that I wrote in less than two hours that I have used in my Rails applications to test what and to whom was getting mailed. All this little server does is respond with kind words; as in, it says <code>OK</code> to everything it can. It&#8217;s an eager server that will reaffirm everything you may have thought about SMTP.</p>

<p>It also wouldn&#8217;t be to hard to ask it to store the emails for grabbing later. It would certainly be a lot less code and a lot friggin&#8217; easier to read.</p>
<div class='highlight'><pre><code class='ruby'><span class='c1'>#!/usr/bin/env ruby</span>

<span class='c1'># I am a stupid SMTP server. Though I speak SMTP, all I do is regurgitate what</span>
<span class='c1'># the sender sends me. Use me for doing manual testing of SMTP clients that have</span>
<span class='c1'># simple needs.</span>
<span class='c1'>#</span>
<span class='c1'># Example usage:</span>
<span class='c1'>#   dumb-smtp.rb localhost 25252</span>
<span class='c1'>#</span>
<span class='c1'># Then, have your client try and send email to localhost:25252 and watch the</span>
<span class='c1'># STDOUT of dumb-smtp. Theoretically, your client will think it actually sent</span>
<span class='c1'># the email and you can observe what your client actually sent.</span>
<span class='c1'>#</span>
<span class='c1'># Feel free to keep me simple by leaving me alone; unless you have some cool </span>
<span class='c1'># ideas.</span>
<span class='c1'>#</span>
<span class='c1'># I have been known to work extremely well with ActionMailer :)</span>
<span class='c1'>#</span>
<span class='nb'>require</span> <span class='s1'>&#39;socket&#39;</span>

<span class='k'>class</span> <span class='nc'>SmtpResponder</span>
  <span class='k'>def</span> <span class='nf'>initialize</span>
    <span class='vi'>@data</span> <span class='o'>=</span> <span class='kp'>false</span>
    <span class='vi'>@closed</span> <span class='o'>=</span> <span class='kp'>false</span>
    <span class='vi'>@domain</span> <span class='o'>=</span> <span class='s1'>&#39;&#39;</span>
  <span class='k'>end</span>

  <span class='k'>def</span> <span class='nf'>handle</span><span class='p'>(</span><span class='n'>line</span><span class='p'>)</span>
    <span class='n'>line</span> <span class='o'>=</span> <span class='n'>line</span><span class='o'>.</span><span class='n'>strip</span>
    <span class='k'>return</span> <span class='n'>more_data</span><span class='p'>(</span><span class='n'>line</span><span class='p'>)</span> <span class='k'>if</span> <span class='vi'>@data</span>

    <span class='n'>command</span><span class='p'>,</span> <span class='n'>data</span> <span class='o'>=</span> <span class='o'>*</span><span class='n'>line</span><span class='o'>.</span><span class='n'>split</span><span class='p'>(</span><span class='s1'>&#39; &#39;</span><span class='p'>,</span> <span class='mi'>2</span><span class='p'>)</span>
    <span class='n'>command</span> <span class='o'>=</span> <span class='n'>command</span><span class='o'>.</span><span class='n'>downcase</span><span class='o'>.</span><span class='n'>gsub</span><span class='p'>(</span><span class='sr'>/ +/</span><span class='p'>,</span> <span class='s1'>&#39;_&#39;</span><span class='p'>)</span><span class='o'>.</span><span class='n'>to_sym</span>
    <span class='nb'>self</span><span class='o'>.</span><span class='n'>send</span><span class='p'>(</span><span class='n'>command</span><span class='p'>,</span> <span class='n'>data</span><span class='p'>)</span>
  <span class='k'>end</span>

  <span class='k'>def</span> <span class='nf'>ehlo</span><span class='p'>(</span><span class='n'>domain</span><span class='p'>)</span> <span class='vi'>@domain</span> <span class='o'>=</span> <span class='n'>domain</span><span class='p'>;</span> <span class='s2'>&quot;250 OK </span><span class='si'>#{</span><span class='n'>domain</span><span class='si'>}</span><span class='s2'>&quot;</span><span class='p'>;</span> <span class='k'>end</span>

  <span class='k'>def</span> <span class='nf'>ok</span><span class='p'>(</span><span class='n'>info</span><span class='p'>)</span> <span class='s2'>&quot;250 OK </span><span class='si'>#{</span><span class='n'>info</span><span class='si'>}</span><span class='s2'>&quot;</span><span class='p'>;</span> <span class='k'>end</span>
  <span class='k'>alias</span> <span class='ss'>:mail</span> <span class='ss'>:ok</span>
  <span class='k'>alias</span> <span class='ss'>:rcpt</span> <span class='ss'>:ok</span>

  <span class='k'>def</span> <span class='nf'>data</span><span class='p'>(</span><span class='n'>info</span><span class='p'>)</span>
    <span class='vi'>@data</span> <span class='o'>=</span> <span class='kp'>true</span>
    <span class='s2'>&quot;354 Start mail input; end with &lt;CRLF&gt;.&lt;CRLF&gt;&quot;</span>
  <span class='k'>end</span>

  <span class='k'>def</span> <span class='nf'>more_data</span><span class='p'>(</span><span class='n'>data</span><span class='p'>)</span>
    <span class='k'>return</span> <span class='kp'>nil</span> <span class='k'>unless</span> <span class='n'>data</span> <span class='o'>==</span> <span class='s2'>&quot;.&quot;</span>
    <span class='vi'>@data</span> <span class='o'>=</span> <span class='kp'>false</span>
    <span class='s2'>&quot;250 OK data received&quot;</span>
  <span class='k'>end</span>

  <span class='k'>def</span> <span class='nf'>quit</span><span class='p'>(</span><span class='n'>data</span><span class='p'>)</span>
    <span class='vi'>@closed</span> <span class='o'>=</span> <span class='kp'>true</span>
    <span class='s2'>&quot;221 </span><span class='si'>#{</span><span class='vi'>@domain</span><span class='si'>}</span><span class='s2'> Service closing transmission channel&quot;</span>
  <span class='k'>end</span>

  <span class='k'>def</span> <span class='nf'>closed?</span><span class='p'>;</span> <span class='vi'>@closed</span><span class='p'>;</span> <span class='k'>end</span>

  <span class='k'>def</span> <span class='nf'>method_missing</span><span class='p'>(</span><span class='n'>methodname</span><span class='p'>,</span> <span class='o'>*</span><span class='n'>args</span><span class='p'>)</span>
    <span class='s2'>&quot;500 Syntax error, command unrecognized&quot;</span>
  <span class='k'>end</span>
<span class='k'>end</span>

<span class='n'>server</span> <span class='o'>=</span> <span class='no'>TCPServer</span><span class='o'>.</span><span class='n'>open</span><span class='p'>(</span><span class='no'>ARGV</span><span class='o'>[</span><span class='mi'>0</span><span class='o'>]</span><span class='p'>,</span> <span class='no'>ARGV</span><span class='o'>[</span><span class='mi'>1</span><span class='o'>]</span><span class='p'>)</span>
<span class='k'>while</span> <span class='p'>(</span><span class='n'>socket</span> <span class='o'>=</span> <span class='n'>server</span><span class='o'>.</span><span class='n'>accept</span><span class='p'>)</span>
  <span class='n'>socket</span><span class='o'>.</span><span class='n'>puts</span><span class='p'>(</span><span class='s2'>&quot;220 dumb-smtp.foo Service ready&quot;</span><span class='p'>)</span>
  <span class='n'>responder</span> <span class='o'>=</span> <span class='no'>SmtpResponder</span><span class='o'>.</span><span class='n'>new</span>
  <span class='n'>socket</span><span class='o'>.</span><span class='n'>each</span> <span class='k'>do</span> <span class='o'>|</span><span class='n'>line</span><span class='o'>|</span>
    <span class='vg'>$stdout</span><span class='o'>.</span><span class='n'>puts</span><span class='p'>(</span><span class='s2'>&quot;-- </span><span class='si'>#{</span><span class='n'>line</span><span class='o'>.</span><span class='n'>strip</span><span class='si'>}</span><span class='s2'>&quot;</span><span class='p'>)</span>
    <span class='n'>response</span> <span class='o'>=</span> <span class='n'>responder</span><span class='o'>.</span><span class='n'>handle</span><span class='p'>(</span><span class='n'>line</span><span class='p'>)</span>
    <span class='k'>if</span> <span class='n'>response</span>
      <span class='vg'>$stdout</span><span class='o'>.</span><span class='n'>puts</span><span class='p'>(</span><span class='s2'>&quot;&lt;&lt; </span><span class='si'>#{</span><span class='n'>response</span><span class='si'>}</span><span class='s2'>&quot;</span><span class='p'>)</span>
      <span class='n'>socket</span><span class='o'>.</span><span class='n'>puts</span><span class='p'>(</span><span class='n'>response</span><span class='p'>)</span>
    <span class='k'>end</span>
    <span class='k'>break</span> <span class='k'>if</span> <span class='n'>responder</span><span class='o'>.</span><span class='n'>closed?</span>
  <span class='k'>end</span>
  <span class='n'>socket</span><span class='o'>.</span><span class='n'>close</span>
<span class='k'>end</span>
<span class='n'>server</span><span class='o'>.</span><span class='n'>close</span>
</code></pre>
</div>
<p>If you do as the comments say, you&#8217;re golden. You can even tell your appropriate Rails configuration file to talk to the port you reference and it will work. You could do that like so in your <code>development.rb</code>:</p>
<div class='highlight'><pre><code class='ruby'><span class='no'>ActionMailer</span><span class='o'>::</span><span class='no'>Base</span><span class='o'>.</span><span class='n'>delivery_method</span> <span class='o'>=</span> <span class='ss'>:smtp</span>
<span class='no'>ActionMailer</span><span class='o'>::</span><span class='no'>Base</span><span class='o'>.</span><span class='n'>smtp_settings</span> <span class='o'>=</span> <span class='p'>{</span>
  <span class='ss'>:address</span> <span class='o'>=&gt;</span> <span class='s1'>&#39;localhost&#39;</span><span class='p'>,</span> <span class='ss'>:port</span> <span class='o'>=&gt;</span> <span class='mi'>25252</span><span class='p'>,</span> <span class='ss'>:domain</span> <span class='o'>=&gt;</span> <span class='s1'>&#39;foo.bar&#39;</span>
<span class='p'>}</span>
</code></pre>
</div>
<p>Now, I should note that I wrote this while <a href='http://centro.net'>working for Centro</a> &#8230; my ex-employer, silly.</p></div>

  <div id="grumble">
    <h4 class="count"></h4>
    <ul></ul>

    <div id="disqus_thread"></div>
    <!-- script type="text/javascript" src="http://disqus.com/forums/gusgus/embed.js"></script -->
    <noscript><a href="http://disqus.com/forums/gusgus/?url=ref">View the discussion thread.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">powered by <span class="logo-disqus">Disqus</span></a>
  </div>
</div>

<div id="right" class="grid_3 omega column">
  <ul>
    <h3>Into the Past</h3>
    <li>
      <a href="/code/ruby/canonical.html">Canonical</a>
      <p><em>Rails ActionMailer extension for substituting inline email addresses</em></p>
    </li>

    <li>
      <a href="/life/i-voted-2008.html">I Voted!</a>
      <p><em>I did it again</em></p>
    </li>
  </ul>
</div>

      </div>

      <div class='grid_12 alpha omega' id='footer'>
        <a href="http://feeds2.feedburner.com/gusgus" rel="alternate" type="application/rss+xml">
          <img src="http://www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt="" style="vertical-align:middle;border:0"/></a>
        &copy; 2007 -  Justin Knowlden /
        <span id="other_thumble_monks">
          Other Thumble Monks:
          <a href="http://annealer.org/">Annealer</a>,
          <a href="http://github.com/danhodos">Sandman</a>,
          <a href="http://toothrot.net/">Toothrot</a>,
          <a href="http://hjstudios.com/">JankStar</a>,
          <a href="http://andrijevik.net/">Vladka</a>
        </span>
      </div>
    </div>

    <script src="/javascripts/jquery-1.3.2.min.js"></script>
    <script src="/javascripts/disqus.js"></script>
    <script src="/javascripts/application.js"></script>
    <script src="/javascripts/ga.js"></script>
  </body>
</html>