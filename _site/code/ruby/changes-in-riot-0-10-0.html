<?xml version='1.0' encoding='utf-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <head>
    <meta content='GROW UP' http-equiv='X-UA-Compatible' />
    <meta content='width=960' name='viewport' />
    <title>The Knowldenist - Drink Up! - Changes in Riot 0.10</title>
    <link href='/images/gusgus_icon.gif' rel='icon' />
    <link href="http://feeds.feedburner.com/gusgus" rel="alternate" title="The Knowldenist" type="application/atom+xml" />
    <link href='http://gusg.us/feed.xml' rel='alternate' title='The Knowldenist' type='application/atom+xml' />
    <link href="/stylesheets/reset.css" type="text/css" media="screen" rel="stylesheet"/>
    <link href="/stylesheets/960.css" type="text/css" media="screen" rel="stylesheet"/>
    <link href="/stylesheets/text.css" type="text/css" media="screen" rel="stylesheet"/>
    <link href="/stylesheets/application.css" type="text/css" media="screen" rel="stylesheet"/>
    <link href="/stylesheets/pygment-native.css" type="text/css" media="screen" rel="stylesheet"/>
  </head>

  <body>
    <div class='container_12'>
      <div id='header'>
        <div id="title" class="grid_4 alpha">
          <span class="article">The</span><span class="noun"><a href="/">Knowldenist</a></span>
        </div>
        <div id="nav" class="grid_8 omega">
          <ul>
            <li>
              Read
              <ul><li><a href="/">Home</a></li></ul>
            </li>
            <li>
              Blurp!
              <ul><li><a href="/blurp/">Excuse me</a></li></ul>
            </li>
            <li>
              Code
              <ul>
                <li><a href="http://github.com/jaknowlden">jaknowlden</a></li>
                <li><a href="http://github.com/thumblemonks">thumblemonks</a></li>
              </ul>
            </li>
            <li>
              Links
              <ul>
                <li><a href="http://tumblr.gusg.us/">Tumblr</a></li>
                <li><a href="http://twitter.com/jaknowlden">Twittr</a></li>
                <li><a href="http://flickr.com/jaknowlden">Flickr</a></li>
              </ul>
            </li>
          </ul>
        </div>
      </div>

      <div id="main" class='grid_12 alpha omega'>
        <div id="page_title">
  <h1>Changes in Riot 0.10</h1>
  <div class="summary"><em>Changes to the Ruby, Riot testing framework in version 0.10</em></div>
</div>

<div class="grid_9 alpha">
  <div id="left" class="grid_3 alpha column">
    <ul>
      <h3>Into the Future</h3>
      <li>
        <a href="/code/cant-spell-waterfall.html">Random Thoughts, ed. 3 - Can't Spell Waterfall</a>
        <p><em>At least not without these other spellings</em></p>
      </li>

      <li>
        <a href="/life/narcissus.html">Narcissus</a>
        <p><em>The band with myopic love</em></p>
      </li>

    <h3>Check me out!</h3>
      <p><em>
        <a href="http://github.com/thumblemonks/riot">Riot</a> for fast ruby testing,
        <a href="http://jubilator.thumblemonks.com/" title="Browse GitHub in style">Jubilator</a> for GitHub browsing,
        <a href="http://seota.thumblemonks.com/" title="Semi-automatic SEO assistance">Seota</a> for semi-automatic SEO help,
        <a href="http://github.com/thumblemonks/animalcracker">Animal Cracker</a> for Rack asset hosting assistance,
        <a href="http://github.com/thumblemonks/riot">Chicago</a> for Sinatra helpers
      </em></p>
    </ul>
  </div>

  <div id="article" class="grid_6 omega">
    <div id="info">
      <div class="date"><cite>Nov 23, 2009</cite></div>
    </div>

    <div class="content"><p>Though I&#8217;ve never blogged about <a href='http://github.com/thumblemonks/riot'>Riot</a>, it received some awesome and much unexpected attention from <a href='http://alexyoung.org/2009/10/26/riot-testing/'>Alex Young</a> (a super-awesome dude), <a href='http://www.rubyinside.com/riot-for-fast-expressive-and-focused-unit-tests-2669.html'>Ruby Inside</a> via <a href='http://www.ricroberts.com/'>Ric Roberts</a> (another super-awesome dude), <a href='http://railsenvy.com/2009/10/28/episode-098'>Rails Envy</a>, and <a href='http://ruby5.envylabs.com/episodes/24-episode-23-october-30-2009/stories/186-riot-testing-framework'>Ruby5</a>. I was overcome to say the least, partly because I wasn&#8217;t happy with where Riot was at that moment, but mostly because I wrote Riot for me and didn&#8217;t think anyone (except for <a href='http://toothrot.net/'>toothrot</a> and <a href='http://github.com/jonpliske'>jonpliske</a>) would actually think Riot was for them.</p>

<p>I was wrong.</p>

<p>In the short period of time between then and now I have received a lot of positive feedback and only vicariously have seen some negative feedback &#8230; which I will ignore because - as I said before - I wrote Riot for me. Also in that time I have received some of that famous help from the open-source community. <a href='http://annealer.org'>annealer</a> and <a href='http://github.com/brianc'>brianc</a> (also the lead singer of <a href='http://deadblackhearts.com/'>Dead Black Hearts</a> - which is awesome) helped me to narrow in on what Riot was trying to accomplish and to do it with a more efficient engine. I&#8217;m happy to say I&#8217;m much happier with how Riot is implemented today than I was when <a href='http://gemcutter.org/gems/riot/versions/0.9.12'>0.9.12</a> was released.</p>

<p>&#8220;Whatever! The changes, Jabberjaw&#8221;, you exclaim. Fine. In terms of DSL, there aren&#8217;t many changes.</p>

<h4 id='assertion_macros'>Assertion macros</h4>

<p>The biggest observable change by far is in the way you write assertion macros, such as: <code>equals</code>, <code>raises</code>, <code>kind_of</code>, etc. You won&#8217;t need to do this very often, but when you do you won&#8217;t be defining a new method that can be included into <code>Riot::Assertion</code>. Now, you will be writing an assertion macro block. But, examples are the best way to show this. So, instead of writing the <code>kind_of</code> macros like this:</p>
<div class='highlight'><pre><code class='ruby'><span class='k'>module</span> <span class='nn'>My</span>
  <span class='k'>module</span> <span class='nn'>AssertionMacros</span>

    <span class='k'>def</span> <span class='nf'>kind_of</span><span class='p'>(</span><span class='n'>expected</span><span class='p'>)</span>
      <span class='n'>actual</span><span class='o'>.</span><span class='n'>kind_of?</span><span class='p'>(</span><span class='n'>expected</span><span class='p'>)</span> <span class='o'>||</span> <span class='nb'>fail</span><span class='p'>(</span><span class='s2'>&quot;expected kind of </span><span class='si'>#{</span><span class='n'>expected</span><span class='si'>}</span><span class='s2'>, not </span><span class='si'>#{</span><span class='n'>actual</span><span class='o'>.</span><span class='n'>inspect</span><span class='si'>}</span><span class='s2'>&quot;</span><span class='p'>)</span>
    <span class='k'>end</span>

  <span class='k'>end</span>
<span class='k'>end</span>

<span class='no'>Riot</span><span class='o'>::</span><span class='no'>Assertion</span><span class='o'>.</span><span class='n'>instance_eval</span> <span class='p'>{</span> <span class='kp'>include</span> <span class='no'>My</span><span class='o'>::</span><span class='no'>AssertionMacros</span> <span class='p'>}</span>
</code></pre>
</div>
<p>you&#8217;re going to write them like this:</p>
<div class='highlight'><pre><code class='ruby'><span class='k'>class</span> <span class='nc'>Riot</span><span class='o'>::</span><span class='no'>Assertion</span>

  <span class='n'>assertion</span><span class='p'>(</span><span class='ss'>:kind_of</span><span class='p'>)</span> <span class='k'>do</span> <span class='o'>|</span><span class='n'>actual</span><span class='p'>,</span> <span class='n'>expected</span><span class='o'>|</span>
    <span class='n'>actual</span><span class='o'>.</span><span class='n'>kind_of?</span><span class='p'>(</span><span class='n'>expected</span><span class='p'>)</span> <span class='p'>?</span> <span class='n'>pass</span> <span class='p'>:</span> <span class='nb'>fail</span><span class='p'>(</span><span class='s2'>&quot;expected kind of </span><span class='si'>#{</span><span class='n'>expected</span><span class='si'>}</span><span class='s2'>, not </span><span class='si'>#{</span><span class='n'>actual</span><span class='o'>.</span><span class='n'>inspect</span><span class='si'>}</span><span class='s2'>&quot;</span><span class='p'>)</span>
  <span class='k'>end</span>

<span class='k'>end</span>
</code></pre>
</div>
<p>Why? That has a lot to do with the under-the-hood changes. Important to note are a few things:</p>

<ol>
<li>The obvious closure</li>

<li>The <code>actual</code> value is getting provided-to and no longer requested-by the assertion macro</li>

<li>The <code>pass</code> and <code>fail</code> signals which are required to be returned from any assertion macro</li>
</ol>

<p>Not listed here is an <code>error</code> signal, but you shouldn&#8217;t need to worry about that.</p>

<h4 id='shortcut_assertion_for_the_topic'>Shortcut assertion for the topic</h4>

<p>The assertion shortcut <code>topic</code> has been renamed to <code>asserts_topic</code>, which brianc so elegantly suggested as a better name. Thus, instead of this:</p>
<div class='highlight'><pre><code class='ruby'><span class='n'>context</span> <span class='s2'>&quot;foo&quot;</span> <span class='k'>do</span>
  <span class='n'>setup</span> <span class='p'>{</span> <span class='s2'>&quot;mom&quot;</span> <span class='p'>}</span>
  <span class='n'>topic</span><span class='o'>.</span><span class='n'>kind_of</span><span class='p'>(</span><span class='nb'>String</span><span class='p'>)</span> <span class='c1'># This will no longer work</span>
<span class='k'>end</span>
</code></pre>
</div>
<p>you would now do the following:</p>
<div class='highlight'><pre><code class='ruby'><span class='n'>context</span> <span class='s2'>&quot;foo&quot;</span> <span class='k'>do</span>
  <span class='n'>setup</span> <span class='p'>{</span> <span class='s2'>&quot;mom&quot;</span> <span class='p'>}</span>
  <span class='n'>asserts_topic</span><span class='o'>.</span><span class='n'>kind_of</span><span class='p'>(</span><span class='nb'>String</span><span class='p'>)</span>
<span class='k'>end</span>
</code></pre>
</div>
<p>brianc added another shortcut for doing the same thing, which also allows you to have a custom description. You could write the above example like so:</p>

<h4 id='story_output'>Story output</h4>

<p>After looking at what Alex Young <a href='http://alexyoung.org/2009/11/04/riotjs/'>did for output</a> in his implementation of <a href='http://github.com/alexyoung/riotjs'>Riot for JavaScript</a>, I fell in love. So, this is now the default output format for Riot and what I&#8217;m calling the Story Report since the output kind of reads like a story.</p>
<img src='/images/articles/code/ruby/riot-0-10-1-story-terminal.png' alt='Riot terminal output, story report' />
<p>Who doesn&#8217;t like pictures?</p>

<h4 id='under_the_hood'>Under the hood</h4>

<p>Oh man, everything is a little different. In essence, it&#8217;s a complete re-write. This re-write was going after a few things:</p>

<ol>
<li>Riot needed to be faster. Twice as fast as Shoulda is not compelling.</li>

<li>Riot should keep less state (be more functional), because state is a terrible thing to change</li>

<li>Riot should not run the tests while also parsing the DSL (this REALLY bugged me)</li>
</ol>

<p>In order to accomplish (1) and (3), annealer actually did some <a href='http://github.com/thumblemonks/riot/blob/7cf674c257fbb2e465116ad31b7721c5cba9b23a/lib/riot/experiment.rb'>crazy spiking</a> on what we called the experimental approach. Essentially, anonymous classes, <code>define_method</code>s, and meta-programming galore. And it was good.</p>

<p>But, it did not get me (2) in a way that I thought was most readable. Experimental was a bit too magical for even me and that&#8217;s probably because I&#8217;m not that smart. So, we applied the learnings from experimental with an approach that never changed the state of a Context, Assertion, or Situation and we came up with the hybrid approach. I should say that Context, Assertion, and Situation have state, but the intention is for it not to change while the tests are running. Instead, state should be defined when initializing (or setting up) the respective element.</p>

<p>All of this combined into some really readable code that is now Riot <code>0.10</code>. There are more changes, but you should read the code to discover them. The <a href='http://gist.github.com/240353'>benchmarks</a> are pretty awesome, too. Especially those for Ruby 1.9. If you ask me, there&#8217;s no reason to use mini-test when writing new tests for 1.9. Just switch to Riot ;)</p>

<p>As an aside, the instance that does change state over the course of running a test-suite is the test reporter. I can live with it for now, but it&#8217;d be pretty awesome if the reporter could go stateless. It would also be pretty sweet if someone would run Riot contexts through one of the parallel test distributors out there. The performance gains would be outrageous. If annealer ever finishes his implementation of Jenga, I wouldn&#8217;t have to ask. Ahem!</p>

<h2 id='riot_rails'>Riot Rails</h2>

<p>I would really like some help building out Riot to have custom support for Rails. I started <a href='http://github.com/thumblemonks/riot_rails'>Riot Rails</a> and am slowly adding things as I&#8217;m working on a custom Rails app, but the progress is slow. The progress is slow mainly because I have also side-tracked myself with learning Clojure. I want to learn Clojure because a) I like Lisp, b) I like functional languages, and c) I want to re-write <a href='http://github.com/thumblemonks/evoke'>Evoke</a> with <a href='http://github.com/weavejester/compojure'>Compojure</a>.</p>

<p>Now, re-writing Evoke in Clojure is a simple enough task (except for the delayed job processing which I&#8217;ll have port over), but Clojure is a JVM language. This means Compojure is dependent on Java libraries like: jetty, apache commons, clojure-contrib, etc. Being dependent on so many libraries is just begging for package management and I suppose Maven provides that, but I dislike Maven and Ant for all of their XML horrificness (I used to be a Java programmer). I just hate it. Makes me want to barf. What I do like is Ruby Gems. I really like Ruby Gems. Turns out, annealer hates Maven and likes Ruby Gems as well. So &#8230; what do you think we did?</p>

<p><a href='http://javagems.org'>JavaGems</a>, that&#8217;s what. We up and <a href='http://github.com/javagems'>did it</a> and there will be a LOT more to say about that. However, all of this side-trackiness has kept me from finishing Riot Rails which is not all that hard of a thing to do, it just takes time and as I have already shown I can lose that very quickly.</p>

<p>Thusly and therefore, I&#8217;m calling all arms. Let&#8217;s get Riot Rails finished. It&#8217;ll accomplish what I set out to do, make functional tests in Rails faster. That&#8217;s right! Slowness of Shoulda + Factory Girl + functional-tests made me write Riot. That&#8217;s why Riot only calls <code>setup</code> once per Context. That&#8217;s why finishing Riot Rails will make me oh so very happy.</p>

<p>If you&#8217;d like to help, but not sure how, hop into the <code>#riot</code> room on irc.freenode.net. Ohhhhh &#8230; the riot room, that&#8217;s funny. I know, it&#8217;s really a channel, but whatever! If you don&#8217;t want to do that, just fork and fix.</p></div>
  </div>

  
  <div id="grumble">
    <h4 class="count"></h4>
    <ul></ul>

    <div id="disqus_thread"></div>
    <script type="text/javascript" src="http://disqus.com/forums/gusgus/embed.js"></script>
    <noscript><a href="http://disqus.com/forums/gusgus/?url=ref">View the discussion thread.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">powered by <span class="logo-disqus">Disqus</span></a>
  </div>
  
</div>

<div id="right" class="grid_3 omega column">
  <ul>
    <h3>Into the Past</h3>
    <li>
      <a href="/life/lucid-thoughts-ed2.html">Lucid Thoughts, ed. 1</a>
      <p><em>I couldn't sleep again, again</em></p>
    </li>

    <li>
      <a href="/code/daily-js.html">DailyJS.com</a>
      <p><em>A new (as of this writing) daily news blog for JavaScript stuff</em></p>
    </li>

    <p><em>
      Check out these fine products:
      <a href="http://ackandnak.com/">Ack &amp; Nak</a> many-days-a-week web comic,
      <a href="http://dailyjs.com/">DailyJS</a>,
      <a href="http://helicoid.net/">Helicoid</a>,
      <a href="http://swirrl.com/">Swirrl</a>,
      <a href="http://javagems.org/">Java Gems</a>, et al
    </em></p>
  </ul>
</div>

      </div>

      <div class='grid_12 alpha omega' id='footer'>
        <a href="http://feeds2.feedburner.com/gusgus" rel="alternate" type="application/rss+xml">
          <img src="http://www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt="" style="vertical-align:middle;border:0"/></a>
        &copy; 2007 - right now, Justin Knowlden /
        <span id="other_thumble_monks">
          Other Thumble Monks:
          <a href="http://annealer.org/">Annealer</a>,
          <a href="http://github.com/danhodos">Sandman</a>,
          <a href="http://toothrot.net/">Toothrot</a>,
          <a href="http://hjstudios.com/">JankStar</a>,
          <a href="http://andrijevik.net/">Vladka</a>
        </span>
      </div>
    </div>

    <script src="/javascripts/disqus.js"></script>
    <script src="/javascripts/ga.js"></script>
  </body>
</html>
